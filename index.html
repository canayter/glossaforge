<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="GlossaForge ‚Äî Geospatial linguistics toolkit. Explore world languages, families, typology, and mutual intelligibility.">
  <meta name="theme-color" content="#00d4ff">
  <title>GlossaForge</title>
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TERMINUS ‚Äî Design System
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --void:    #06060e;
  --base:    #0d0d18;
  --raised:  #12121f;
  --surface: #181828;
  --lift:    #1e1e30;
  --hover:   #252538;
  --active:  #2c2c42;
  --border:  rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.13);

  --cyan:      #00d4ff;
  --cyan-dim:  rgba(0,212,255,0.10);
  --cyan-glow: rgba(0,212,255,0.30);

  --violet:     #8b5cf6;
  --violet-dim: rgba(139,92,246,0.12);

  --ink:    #eeeef5;
  --ink-mid:#9898b0;
  --ink-low:#5a5a72;
  --ink-dim:#2e2e44;

  --safe:     #34d399;
  --vuln:     #fbbf24;
  --endanger: #fb923c;
  --severe:   #f87171;
  --critical: #ef4444;
  --extinct:  #52525b;

  --font-head: 'Space Grotesk', system-ui, sans-serif;
  --font-body: 'Inter', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;

  --r-sm: 6px; --r-md: 10px; --r-lg: 16px; --r-xl: 24px; --r-full: 9999px;
  --ease: cubic-bezier(0.16,1,0.3,1);
  --fast: 140ms var(--ease);
  --norm: 240ms var(--ease);
}

[data-theme="light"] {
  --void: #f4f4f8; --base: #ededf3; --raised: #e6e6ee; --surface: #ffffff;
  --lift: #ffffff; --hover: #dddde8; --active: #d4d4e0;
  --border: rgba(0,0,0,0.07); --border2: rgba(0,0,0,0.13);
  --ink: #111120; --ink-mid: #4a4a60; --ink-low: #7a7a90; --ink-dim: #d0d0de;
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0 }
html { scroll-behavior:smooth; -webkit-text-size-adjust:100% }
body {
  font-family:var(--font-body); font-size:15px; color:var(--ink);
  background:var(--void); line-height:1.6; min-height:100vh;
  overflow-x:hidden; -webkit-font-smoothing:antialiased;
}
img,svg { display:block; max-width:100% }
button,input,select,textarea { font:inherit; color:inherit }
a { color:var(--cyan); text-decoration:none }
::selection { background:var(--cyan); color:#000 }
:focus-visible { outline:2px solid var(--cyan); outline-offset:2px; border-radius:var(--r-sm) }
.sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0 }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.site-header {
  position:sticky; top:0; z-index:900; height:56px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 24px;
  background:rgba(6,6,14,0.82); backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
}
[data-theme="light"] .site-header { background:rgba(244,244,248,0.85) }

.logo {
  display:flex; align-items:center; gap:10px;
  font-family:var(--font-head); font-size:1.15rem; font-weight:700;
  letter-spacing:-0.02em; color:var(--ink); cursor:pointer; text-decoration:none;
}
.logo span { color:var(--cyan) }
.logo-sub {
  font-family:var(--font-body); font-size:11px; font-weight:500;
  color:var(--ink-low); letter-spacing:0.04em; text-transform:uppercase;
}

/* ‚îÄ‚îÄ PILL NAV ‚îÄ‚îÄ */
.pill-nav {
  position:absolute; left:50%; transform:translateX(-50%);
  display:flex; align-items:center; gap:2px;
  background:var(--raised); border:1px solid var(--border);
  border-radius:var(--r-full); padding:4px;
}
.pill-nav .pn {
  padding:6px 16px; border-radius:var(--r-full);
  font-family:var(--font-head); font-size:13px; font-weight:500;
  color:var(--ink-mid); cursor:pointer; border:none; background:none;
  transition:all var(--fast); white-space:nowrap;
}
.pill-nav .pn:hover { color:var(--ink); background:var(--hover) }
.pill-nav .pn.active { color:#000; background:var(--cyan); font-weight:600 }
[data-theme="light"] .pill-nav .pn.active { color:#fff }

.header-end { display:flex; align-items:center; gap:8px }
.icon-btn {
  width:36px; height:36px; border-radius:var(--r-md);
  background:var(--raised); border:1px solid var(--border);
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:15px; transition:all var(--fast);
}
.icon-btn:hover { background:var(--hover); border-color:var(--border2) }

/* ‚îÄ‚îÄ MOBILE NAV ‚îÄ‚îÄ */
.mobile-nav {
  display:none; position:fixed; bottom:0; left:0; right:0; z-index:900;
  background:rgba(13,13,24,0.94); backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:6px 0 calc(6px + env(safe-area-inset-bottom));
  justify-content:space-around;
}
[data-theme="light"] .mobile-nav { background:rgba(237,237,243,0.94) }
.mob-link {
  display:flex; flex-direction:column; align-items:center; gap:2px;
  padding:4px 10px; border-radius:var(--r-md);
  font-size:10px; font-weight:500; color:var(--ink-low);
  cursor:pointer; border:none; background:none; transition:all var(--fast);
}
.mob-link .mi { font-size:18px; line-height:1 }
.mob-link:hover,.mob-link.active { color:var(--cyan) }

/* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
main { padding:32px 24px; max-width:1440px; margin:0 auto; padding-bottom:80px }
.views-wrap { padding:32px 24px; max-width:1440px; margin:0 auto; padding-bottom:80px }
.view { display:none }
.view.active { display:block; animation:fadeIn 0.25s var(--ease) }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.home-hero { text-align:center; padding:64px 0 48px }
.home-hero h1 {
  font-family:var(--font-head); font-size:clamp(2.2rem,5vw,3.6rem);
  font-weight:700; letter-spacing:-0.04em; line-height:1.1;
  color:var(--ink); margin-bottom:16px;
}
.home-hero h1 em { font-style:normal; color:var(--cyan) }
.home-hero p { font-size:16px; color:var(--ink-mid); max-width:560px; margin:0 auto 40px; line-height:1.7 }

.stat-row {
  display:flex; flex-wrap:wrap; justify-content:center;
  background:var(--raised); border:1px solid var(--border);
  border-radius:var(--r-xl); overflow:hidden; margin:0 auto 56px; max-width:720px;
}
.stat-cell {
  flex:1; min-width:120px; padding:20px 16px; text-align:center;
  border-right:1px solid var(--border);
}
.stat-cell:last-child { border-right:none }
.stat-val {
  font-family:var(--font-head); font-size:1.9rem; font-weight:700;
  color:var(--cyan); letter-spacing:-0.03em; line-height:1; margin-bottom:4px;
}
.stat-lbl { font-size:11px; font-weight:500; color:var(--ink-low); text-transform:uppercase; letter-spacing:0.06em }

.feat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px }
.feat-card {
  background:var(--raised); border:1px solid var(--border); border-radius:var(--r-lg);
  padding:24px; cursor:pointer; transition:all var(--norm);
  display:flex; flex-direction:column;
}
.feat-card:hover {
  border-color:var(--border2); background:var(--surface);
  transform:translateY(-2px); box-shadow:0 8px 28px rgba(0,0,0,0.35);
}
.feat-icon { font-size:28px; margin-bottom:16px }
.feat-title { font-family:var(--font-head); font-size:1rem; font-weight:600; color:var(--ink); margin-bottom:8px }
.feat-desc { font-size:13px; color:var(--ink-mid); line-height:1.55; flex:1 }
.feat-cta { margin-top:16px; font-size:12px; font-weight:600; color:var(--cyan) }

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.sec-head { margin-bottom:28px }
.sec-head h2 {
  font-family:var(--font-head); font-size:clamp(1.4rem,3vw,1.9rem);
  font-weight:700; letter-spacing:-0.03em; color:var(--ink); margin-bottom:6px;
}
.sec-head p { font-size:14px; color:var(--ink-mid); max-width:560px }

/* ‚îÄ‚îÄ MAP VIEW ‚îÄ‚îÄ */
#view-map {
  display:none;
  position:fixed; top:56px; left:0; right:0; bottom:0;
  overflow:hidden;
}
#view-map.active { display:block }

.map-wrap { position:relative; width:100%; height:100% }
#mapContainer { position:absolute; inset:0; background:#0a0a14 }

.map-float-top {
  position:absolute; top:14px; left:14px; z-index:500;
  display:flex; gap:8px; align-items:center;
}
.map-search-box {
  display:flex; align-items:center; gap:8px;
  background:rgba(13,13,24,0.9); backdrop-filter:blur(12px);
  border:1px solid var(--border2); border-radius:var(--r-lg);
  padding:0 14px; height:40px; min-width:220px;
}
[data-theme="light"] .map-search-box { background:rgba(255,255,255,0.9) }
.map-search-box input {
  background:none; border:none; outline:none;
  font-size:13px; color:var(--ink); flex:1;
}
.map-search-box input::placeholder { color:var(--ink-low) }
.map-search-icon { color:var(--ink-low); font-size:14px }

.map-adv-selects {
  position:absolute; top:62px; left:14px; z-index:500;
  display:flex; gap:6px; flex-wrap:wrap; align-items:center;
}
.map-adv-sel {
  background:rgba(13,13,24,0.88); backdrop-filter:blur(12px);
  border:1px solid var(--border2); border-radius:var(--r-full);
  padding:5px 12px; font-size:11px; color:var(--ink-mid);
}
[data-theme="light"] .map-adv-sel { background:rgba(255,255,255,0.88) }
.map-adv-sel select {
  background:none; border:none; outline:none;
  font:inherit; color:inherit; cursor:pointer;
}
.map-extinct-wrap {
  display:flex; align-items:center; gap:6px;
  background:rgba(13,13,24,0.88); backdrop-filter:blur(12px);
  border:1px solid var(--border2); border-radius:var(--r-full);
  padding:5px 12px; font-size:11px; color:var(--ink-low); cursor:pointer;
}
[data-theme="light"] .map-extinct-wrap { background:rgba(255,255,255,0.88) }
.map-reset-btn {
  background:rgba(13,13,24,0.88); backdrop-filter:blur(12px);
  border:1px solid var(--border2); border-radius:var(--r-full);
  padding:5px 12px; font-size:11px; color:var(--ink-low);
  cursor:pointer; transition:all var(--fast);
}
[data-theme="light"] .map-reset-btn { background:rgba(255,255,255,0.88) }
.map-reset-btn:hover { color:var(--ink) }

.map-count {
  position:absolute; top:14px; right:14px; z-index:500;
  background:rgba(13,13,24,0.88); backdrop-filter:blur(12px);
  border:1px solid var(--border2); border-radius:var(--r-full);
  padding:6px 14px; font-size:12px; color:var(--ink-mid);
}
[data-theme="light"] .map-count { background:rgba(255,255,255,0.88) }

.map-layers {
  position:absolute; bottom:32px; left:50%; transform:translateX(-50%); z-index:500;
  display:flex; gap:4px;
  background:rgba(13,13,24,0.9); backdrop-filter:blur(12px);
  border:1px solid var(--border2); border-radius:var(--r-full); padding:4px;
}
[data-theme="light"] .map-layers { background:rgba(255,255,255,0.9) }
.map-layer-btn {
  padding:6px 18px; border-radius:var(--r-full);
  font-size:12px; font-weight:500; color:var(--ink-low);
  cursor:pointer; border:none; background:none; transition:all var(--fast);
}
.map-layer-btn:hover { color:var(--ink) }
.map-layer-btn.active { background:var(--cyan); color:#000; font-weight:600 }
[data-theme="light"] .map-layer-btn.active { color:#fff }

.map-legend {
  position:absolute; bottom:90px; right:14px; z-index:500;
  background:rgba(13,13,24,0.9); backdrop-filter:blur(12px);
  border:1px solid var(--border2); border-radius:var(--r-lg);
  padding:12px 14px; min-width:140px; max-height:280px; overflow-y:auto;
}
[data-theme="light"] .map-legend { background:rgba(255,255,255,0.9) }
.legend-title { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; color:var(--ink-low); margin-bottom:8px }
.legend-row { display:flex; align-items:center; gap:7px; font-size:12px; color:var(--ink-mid); margin-bottom:5px }
.legend-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0 }

/* Leaflet popup */
.leaflet-popup-content-wrapper {
  background:var(--raised) !important; border:1px solid var(--border2) !important;
  border-radius:var(--r-lg) !important; box-shadow:0 8px 24px rgba(0,0,0,.5) !important;
  color:var(--ink) !important;
}
.leaflet-popup-tip { background:var(--raised) !important }
.leaflet-popup-content { margin:16px !important; font-family:var(--font-body) !important; font-size:13px !important }
.map-popup h3 { font-family:var(--font-head); font-size:1rem; font-weight:600; margin-bottom:4px }
.popup-family { font-size:12px; font-weight:500; margin-bottom:10px }
.popup-row { display:flex; justify-content:space-between; gap:16px; padding:4px 0; border-top:1px solid var(--border) }
.popup-row span:first-child { color:var(--ink-low); font-size:11px }
.popup-row span:last-child { font-size:12px; font-weight:500 }
.popup-link { display:block; margin-top:10px; font-size:11px; font-weight:600; color:var(--cyan) }

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.field-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; color:var(--ink-low); margin-bottom:5px }
.inp {
  width:100%; padding:9px 14px; background:var(--raised);
  border:1px solid var(--border); border-radius:var(--r-md);
  font-size:14px; color:var(--ink); transition:border-color var(--fast); outline:none;
}
.inp:focus { border-color:var(--cyan) }
.inp::placeholder { color:var(--ink-low) }
.sel {
  padding:9px 14px; background:var(--raised);
  border:1px solid var(--border); border-radius:var(--r-md);
  font-size:13px; color:var(--ink); cursor:pointer; outline:none;
  transition:border-color var(--fast);
}
.sel:focus { border-color:var(--cyan) }

/* ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ */
.chip-row { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:16px }
.chip {
  padding:4px 12px; border-radius:var(--r-full);
  font-size:12px; font-weight:500;
  background:var(--raised); border:1px solid var(--border);
  color:var(--ink-mid); cursor:pointer; transition:all var(--fast);
}
.chip:hover { border-color:var(--border2); color:var(--ink) }
.chip.active { background:var(--cyan-dim); border-color:var(--cyan); color:var(--cyan) }

/* ‚îÄ‚îÄ EXPLORER ‚îÄ‚îÄ */
.explorer-top { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:16px; align-items:flex-end }
.explorer-search-wrap { flex:1; min-width:200px }
.result-meta { font-size:12px; color:var(--ink-low); margin-bottom:12px }

.lang-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px }
.lang-card {
  background:var(--raised); border:1px solid var(--border); border-radius:var(--r-lg);
  padding:16px; cursor:pointer; transition:all var(--fast);
}
.lang-card:hover { border-color:var(--border2); background:var(--surface); transform:translateY(-1px) }
.lang-name { font-family:var(--font-head); font-size:0.95rem; font-weight:600; color:var(--ink); margin-bottom:2px }
.lang-native { font-size:12px; color:var(--ink-low); margin-bottom:8px }
.lang-badges { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px }
.fam-tag { padding:2px 8px; border-radius:var(--r-full); font-size:11px; font-weight:600 }
.badge { padding:2px 8px; border-radius:var(--r-full); font-size:11px; font-weight:600 }
.badge-safe { background:rgba(52,211,153,.12); color:var(--safe) }
.badge-vulnerable { background:rgba(251,191,36,.12); color:var(--vuln) }
.badge-endangered { background:rgba(251,146,60,.12); color:var(--endanger) }
.badge-severely { background:rgba(248,113,113,.12); color:var(--severe) }
.badge-critical { background:rgba(239,68,68,.12); color:var(--critical) }
.badge-extinct { background:rgba(82,82,91,.12); color:var(--extinct) }
.lang-foot { display:flex; justify-content:space-between; font-size:11px; color:var(--ink-low) }
.lang-iso { font-family:var(--font-mono); font-size:11px; color:var(--ink-low) }

/* ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ */
.detail-back {
  display:inline-flex; align-items:center; gap:6px;
  font-size:13px; font-weight:500; color:var(--ink-mid);
  cursor:pointer; margin-bottom:24px; background:var(--raised);
  border:1px solid var(--border); border-radius:var(--r-md);
  padding:7px 14px; transition:all var(--fast);
}
.detail-back:hover { border-color:var(--border2); color:var(--ink) }
.detail-wrap { max-width:900px }
.detail-name {
  font-family:var(--font-head); font-size:clamp(1.6rem,4vw,2.4rem);
  font-weight:700; letter-spacing:-0.03em; color:var(--ink); margin-bottom:4px;
}
.detail-sub { font-size:14px; color:var(--ink-mid); margin-bottom:4px }
.detail-alts { font-size:12px; color:var(--ink-low); margin-bottom:16px }
.detail-tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:28px }
.detail-sec { margin-bottom:28px }
.detail-sec-title {
  font-family:var(--font-head); font-size:13px; font-weight:600;
  text-transform:uppercase; letter-spacing:.08em; color:var(--ink-low);
  margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--border);
}
.detail-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px }
.detail-field { background:var(--raised); border:1px solid var(--border); border-radius:var(--r-md); padding:10px 14px }
.detail-lbl { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; color:var(--ink-low); margin-bottom:3px }
.detail-val { font-size:13px; font-weight:500; color:var(--ink) }

/* ‚îÄ‚îÄ FAMILIES ‚îÄ‚îÄ */
.tree-fam {
  background:var(--raised); border:1px solid var(--border);
  border-radius:var(--r-lg); margin-bottom:8px; overflow:hidden;
}
.tree-fam-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 18px; cursor:pointer; transition:background var(--fast); user-select:none;
}
.tree-fam-head:hover { background:var(--hover) }
.tree-fam-left { display:flex; align-items:center; gap:10px; font-family:var(--font-head); font-size:0.95rem; font-weight:600; color:var(--ink) }
.tree-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0 }
.tree-chevron { font-size:10px; color:var(--ink-low); transition:transform var(--fast); margin-left:4px }
.tree-chevron.open { transform:rotate(90deg) }
.tree-fam-stats { font-size:12px; color:var(--ink-low); display:flex; gap:16px }
.tree-body { display:none; border-top:1px solid var(--border) }
.tree-body.open { display:block }
.tree-branch { padding:6px 16px 6px 32px; border-bottom:1px solid var(--border) }
.tree-branch:last-child { border-bottom:none }
.tree-branch-head {
  display:flex; align-items:center; gap:8px; padding:7px 0;
  cursor:pointer; font-size:13px; font-weight:600; color:var(--ink-mid);
  transition:color var(--fast); user-select:none;
}
.tree-branch-head:hover { color:var(--ink) }
.tree-sub-body { display:none; padding-left:16px }
.tree-sub-body.open { display:block }
.tree-lang {
  display:flex; align-items:center; justify-content:space-between;
  padding:5px 8px; border-radius:var(--r-sm);
  font-size:12px; color:var(--ink-mid); cursor:pointer; transition:all var(--fast);
}
.tree-lang:hover { background:var(--hover); color:var(--ink) }
.tree-lang-iso { font-family:var(--font-mono); font-size:10px; color:var(--ink-dim) }

/* ‚îÄ‚îÄ TOOLS ‚îÄ‚îÄ */
.tool-tabs {
  display:flex; gap:4px; margin-bottom:24px;
  border-bottom:1px solid var(--border); padding-bottom:0;
}
.tool-tab {
  padding:10px 20px; font-family:var(--font-head); font-size:13px; font-weight:500;
  color:var(--ink-low); cursor:pointer; border:none; background:none;
  border-bottom:2px solid transparent; margin-bottom:-1px; transition:all var(--fast);
}
.tool-tab:hover { color:var(--ink) }
.tool-tab.active { color:var(--cyan); border-bottom-color:var(--cyan) }
.tool-panel { display:none }
.tool-panel.active { display:block; animation:fadeIn .2s var(--ease) }
.tool-h { font-family:var(--font-head); font-size:1.1rem; font-weight:600; margin-bottom:6px; color:var(--ink) }
.tool-sub { font-size:13px; color:var(--ink-mid); margin-bottom:20px; max-width:560px }

.bar-wrap { background:var(--raised); border-radius:var(--r-full); height:5px; overflow:hidden; flex:1 }
.bar-fill { height:100%; border-radius:var(--r-full); transition:width .4s var(--ease) }

.res-card {
  background:var(--raised); border:1px solid var(--border); border-radius:var(--r-lg);
  padding:14px 16px; margin-bottom:8px; transition:border-color var(--fast);
}
.res-card:hover { border-color:var(--border2) }

.tbl-scroll { overflow-x:auto; border-radius:var(--r-lg); border:1px solid var(--border) }
.comp-table { width:100%; border-collapse:collapse; font-size:13px }
.comp-table th {
  background:var(--surface); padding:10px 14px; text-align:left;
  font-family:var(--font-head); font-size:11px; font-weight:600;
  text-transform:uppercase; letter-spacing:.06em; color:var(--ink-low);
  border-bottom:1px solid var(--border);
}
.comp-table td { padding:9px 14px; border-bottom:1px solid var(--border); color:var(--ink-mid) }
.comp-table td:first-child { color:var(--ink-low); font-size:12px }
.comp-table tr.match td { color:var(--ink); background:rgba(0,212,255,.04) }
.comp-table tr:last-child td { border-bottom:none }

.timeline { position:relative; padding-left:24px }
.timeline::before { content:''; position:absolute; left:6px; top:0; bottom:0; width:1px; background:var(--border) }
.tl-item { position:relative; padding:8px 0 8px 20px; margin-bottom:2px }
.tl-dot { position:absolute; left:-18px; top:13px; width:8px; height:8px; border-radius:50% }
.tl-period { font-family:var(--font-mono); font-size:11px; color:var(--ink-low); margin-bottom:2px }
.tl-name { font-size:13px; font-weight:600; color:var(--ink); margin-bottom:1px }
.tl-meta { font-size:11px; color:var(--ink-low) }

.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:20px }
.stats-card { background:var(--raised); border:1px solid var(--border); border-radius:var(--r-lg); padding:20px }
.stats-card-title { font-family:var(--font-head); font-size:13px; font-weight:600; color:var(--ink); margin-bottom:14px }
.stats-row-item { margin-bottom:10px }
.stats-bar-top { display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px; color:var(--ink-mid) }

/* ‚îÄ‚îÄ KNOWLEDGE ‚îÄ‚îÄ */
.know-sec { margin-bottom:32px }
.know-sec-title {
  font-family:var(--font-head); font-size:13px; font-weight:600;
  text-transform:uppercase; letter-spacing:.08em; color:var(--ink-low);
  margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid var(--border);
}
.source-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px }
.source-card { background:var(--raised); border:1px solid var(--border); border-radius:var(--r-lg); padding:18px }
.source-name { font-family:var(--font-head); font-size:0.9rem; font-weight:600; margin-bottom:6px; color:var(--ink) }
.source-desc { font-size:12px; color:var(--ink-mid); line-height:1.55; margin-bottom:8px }
.source-url { font-family:var(--font-mono); font-size:11px; color:var(--cyan) }

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
.site-footer {
  text-align:center; padding:24px;
  font-size:11px; color:var(--ink-low);
  border-top:1px solid var(--border); margin-top:32px;
}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 18px; border-radius:var(--r-md);
  font-family:var(--font-head); font-size:13px; font-weight:600;
  cursor:pointer; border:1px solid transparent; transition:all var(--fast);
}
.btn-primary { background:var(--cyan); color:#000; border-color:var(--cyan) }
.btn-primary:hover { opacity:.88; box-shadow:0 0 20px var(--cyan-glow) }
.btn-ghost { background:var(--raised); color:var(--ink); border-color:var(--border) }
.btn-ghost:hover { background:var(--hover); border-color:var(--border2) }
.btn-sm { padding:5px 14px; font-size:12px }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width:768px) {
  .pill-nav { display:none }
  .mobile-nav { display:flex }
  main,.views-wrap { padding:20px 16px 100px }
  .home-hero { padding:32px 0 28px }
  .stat-row { max-width:100% }
  .stat-cell { min-width:80px; padding:14px 8px }
  .stat-val { font-size:1.4rem }
  .map-adv-selects { display:none }
  .map-layers { bottom:80px }
  .logo-sub { display:none }
}
@media (max-width:480px) {
  .stat-cell { flex-basis:50% }
  .stat-cell:nth-child(2) { border-right:none }
  .stat-cell:nth-child(3),.stat-cell:nth-child(4) { border-top:1px solid var(--border) }
  .stat-cell:nth-child(5) { border-top:1px solid var(--border); flex-basis:100%; border-right:none }
}
  </style>
</head>
<body>

<a class="sr-only" href="#main-content">Skip to content</a>

<!-- HEADER -->
<header class="site-header">
  <a class="logo" onclick="switchToView('home')" href="#">
    Glossa<span>Forge</span>
    <span class="logo-sub">Geospatial Linguistics</span>
  </a>
  <nav class="pill-nav" aria-label="Main navigation">
    <button class="pn active" data-view="home">Home</button>
    <button class="pn" data-view="map">Map</button>
    <button class="pn" data-view="explorer">Explorer</button>
    <button class="pn" data-view="families">Families</button>
    <button class="pn" data-view="tools">Tools</button>
    <button class="pn" data-view="knowledge">Sources</button>
  </nav>
  <div class="header-end">
    <button class="icon-btn" id="themeToggle" aria-label="Toggle theme">üåô</button>
  </div>
</header>

<!-- MOBILE NAV -->
<nav class="mobile-nav" aria-label="Mobile navigation">
  <button class="mob-link active" data-view="home"><span class="mi">üè†</span>Home</button>
  <button class="mob-link" data-view="map"><span class="mi">üó∫</span>Map</button>
  <button class="mob-link" data-view="explorer"><span class="mi">üîç</span>Explorer</button>
  <button class="mob-link" data-view="families"><span class="mi">üå≥</span>Families</button>
  <button class="mob-link" data-view="tools"><span class="mi">üß∞</span>Tools</button>
  <button class="mob-link" data-view="knowledge"><span class="mi">üìö</span>Sources</button>
</nav>

<!-- HOME (inside main) -->
<main id="main-content">
  <section id="view-home" class="view active">
    <div class="home-hero">
      <h1>Glossa<em>Forge</em></h1>
      <p>Explore the world's languages ‚Äî their families, geography, typology, endangerment, and connections. An evidence-based toolkit for linguists, polyglots, and the curious.</p>
    </div>
    <div class="stat-row" id="homeStats">
      <div class="stat-cell"><div class="stat-val" id="statLangs">‚Äî</div><div class="stat-lbl">Languages</div></div>
      <div class="stat-cell"><div class="stat-val" id="statFamilies">‚Äî</div><div class="stat-lbl">Families</div></div>
      <div class="stat-cell"><div class="stat-val" id="statSpeakers">‚Äî</div><div class="stat-lbl">Speakers</div></div>
      <div class="stat-cell"><div class="stat-val" id="statEndangered">‚Äî</div><div class="stat-lbl">Endangered</div></div>
      <div class="stat-cell"><div class="stat-val" id="statExtinct">‚Äî</div><div class="stat-lbl">Extinct</div></div>
    </div>
    <div class="feat-grid">
      <div class="feat-card" onclick="switchToView('map')">
        <div class="feat-icon">üó∫Ô∏è</div>
        <div class="feat-title">World Map</div>
        <p class="feat-desc">Interactive map of 500+ languages. Color by family, endangerment, word order, or morphology. Filter and search in real time.</p>
        <span class="feat-cta">Open Map ‚Üí</span>
      </div>
      <div class="feat-card" onclick="switchToView('explorer')">
        <div class="feat-icon">üîç</div>
        <div class="feat-title">Language Explorer</div>
        <p class="feat-desc">Search and filter by name, family, region, typological features, or endangerment status. View full typological profiles.</p>
        <span class="feat-cta">Explore ‚Üí</span>
      </div>
      <div class="feat-card" onclick="switchToView('families')">
        <div class="feat-icon">üå≥</div>
        <div class="feat-title">Family Trees</div>
        <p class="feat-desc">Hierarchical view of all language families ‚Äî from Indo-European to isolates. Browse branches and individual languages.</p>
        <span class="feat-cta">View Families ‚Üí</span>
      </div>
      <div class="feat-card" onclick="switchToView('tools')">
        <div class="feat-icon">üß∞</div>
        <div class="feat-title">Linguistics Tools</div>
        <p class="feat-desc">Mutual intelligibility matcher, grammatical similarity finder, side-by-side comparison, historical timeline, and world statistics.</p>
        <span class="feat-cta">Open Tools ‚Üí</span>
      </div>
      <div class="feat-card" onclick="switchToView('knowledge')">
        <div class="feat-icon">üìö</div>
        <div class="feat-title">Sources &amp; Methods</div>
        <p class="feat-desc">Data sources, methodology notes, and academic references. Built on Glottolog, WALS, PHOIBLE, and UNESCO Atlas.</p>
        <span class="feat-cta">View Sources ‚Üí</span>
      </div>
    </div>
  </section>
</main>

<!-- MAP (fixed, full viewport) -->
<section id="view-map" class="view">
  <div class="map-wrap">
    <div id="mapContainer"></div>
    <div class="map-float-top">
      <div class="map-search-box">
        <span class="map-search-icon">‚åï</span>
        <input type="text" id="mapSearch" placeholder="Search language or ISO code‚Ä¶" autocomplete="off">
      </div>
    </div>
    <div class="map-adv-selects" id="mapAdvFilters">
      <div class="map-adv-sel"><select id="mapFamily"><option value="">All Families</option></select></div>
      <div class="map-adv-sel"><select id="mapRegion"><option value="">All Regions</option></select></div>
      <div class="map-adv-sel"><select id="mapWordOrder"><option value="">Word Order</option></select></div>
      <div class="map-adv-sel"><select id="mapMorphType"><option value="">Morphology</option></select></div>
      <div class="map-adv-sel"><select id="mapEndangerment">
        <option value="">Any Status</option>
        <option value="safe">Safe</option>
        <option value="vulnerable">Vulnerable</option>
        <option value="definitely_endangered">Endangered</option>
        <option value="severely_endangered">Severely Endangered</option>
        <option value="critically_endangered">Critically Endangered</option>
        <option value="extinct">Extinct</option>
      </select></div>
      <div class="map-adv-sel"><select id="mapTone"><option value="">Tone</option></select></div>
      <label class="map-extinct-wrap"><input type="checkbox" id="mapShowExtinct" style="accent-color:var(--cyan)"> Show extinct</label>
      <button class="map-reset-btn" onclick="resetMapFilters()">Reset</button>
    </div>
    <div class="map-count" id="mapFilterCount"></div>
    <div class="map-layers">
      <button class="map-layer-btn active" data-layer="family">Family</button>
      <button class="map-layer-btn" data-layer="endangerment">Endangerment</button>
      <button class="map-layer-btn" data-layer="wordorder">Word Order</button>
      <button class="map-layer-btn" data-layer="morphology">Morphology</button>
      <button class="map-layer-btn" data-layer="tone">Tone</button>
    </div>
    <div id="mapLegend" class="map-legend"></div>
  </div>
</section>

<!-- OTHER VIEWS -->
<div class="views-wrap">

  <!-- EXPLORER -->
  <section id="view-explorer" class="view">
    <div class="sec-head"><h2>Language Explorer</h2><p>Search and filter 500+ world languages. Click any card for a full typological profile.</p></div>
    <div class="explorer-top">
      <div class="explorer-search-wrap">
        <div class="field-label">Search</div>
        <input class="inp" type="text" id="explorerSearch" placeholder="Name, ISO code, or alternate name‚Ä¶">
      </div>
      <div><div class="field-label">Family</div><select class="sel" id="explorerFamily"><option value="">All</option></select></div>
      <div><div class="field-label">Region</div><select class="sel" id="explorerRegion"><option value="">All</option></select></div>
      <div><div class="field-label">Status</div>
        <select class="sel" id="explorerEndanger">
          <option value="">Any</option>
          <option value="safe">Safe</option>
          <option value="vulnerable">Vulnerable</option>
          <option value="definitely_endangered">Endangered</option>
          <option value="severely_endangered">Severely Endangered</option>
          <option value="critically_endangered">Critically Endangered</option>
          <option value="extinct">Extinct</option>
        </select>
      </div>
    </div>
    <div class="chip-row" id="explorerChips"></div>
    <div class="result-meta" id="explorerCount"></div>
    <div class="lang-grid" id="explorerResults"></div>
    <div id="explorerDetail" style="display:none"></div>
  </section>

  <!-- FAMILIES -->
  <section id="view-families" class="view">
    <div class="sec-head"><h2>Language Families</h2><p>Hierarchical view of the world's language families, branches, and individual languages.</p></div>
    <div style="max-width:400px;margin-bottom:24px">
      <div class="field-label">Search</div>
      <input class="inp" type="text" id="familySearch" placeholder="Search family or language name‚Ä¶">
    </div>
    <div class="stat-row" id="familyStats" style="max-width:600px;margin-bottom:28px"></div>
    <div id="familyTree"></div>
  </section>

  <!-- TOOLS -->
  <section id="view-tools" class="view">
    <div class="sec-head"><h2>Linguistics Tools</h2><p>Analyze languages with matching, comparison, and visualization tools.</p></div>
    <div class="tool-tabs" role="tablist">
      <button class="tool-tab active" data-tool="intelligibility" role="tab" aria-selected="true">Intelligibility</button>
      <button class="tool-tab" data-tool="similarity" role="tab" aria-selected="false">Grammar Similarity</button>
      <button class="tool-tab" data-tool="comparison" role="tab" aria-selected="false">Comparison</button>
      <button class="tool-tab" data-tool="timeline" role="tab" aria-selected="false">Timeline</button>
      <button class="tool-tab" data-tool="stats" role="tab" aria-selected="false">World Stats</button>
    </div>
    <div id="tool-intelligibility" class="tool-panel active" role="tabpanel">
      <div class="tool-h">Mutual Intelligibility Matcher</div>
      <p class="tool-sub">Select a language to see which others its speakers can understand ‚Äî and to what degree. Intelligibility is often asymmetric.</p>
      <div style="max-width:400px;margin-bottom:20px"><div class="field-label">Select Language</div><select class="sel" id="intelligibilityLang" style="width:100%"><option value="">Choose a language‚Ä¶</option></select></div>
      <div id="intelligibilityResults"></div>
    </div>
    <div id="tool-similarity" class="tool-panel" role="tabpanel">
      <div class="tool-h">Grammatical Similarity Finder</div>
      <p class="tool-sub">Find languages that share grammatical features ‚Äî even across unrelated families. Scored across word order, morphology, case alignment, tone, gender, and more.</p>
      <div style="max-width:400px;margin-bottom:20px"><div class="field-label">Select Language</div><select class="sel" id="similarityLang" style="width:100%"><option value="">Choose a language‚Ä¶</option></select></div>
      <div id="similarityResults"></div>
    </div>
    <div id="tool-comparison" class="tool-panel" role="tabpanel">
      <div class="tool-h">Language Comparison</div>
      <p class="tool-sub">Select 2‚Äì5 languages for a side-by-side typological comparison. Matching features are highlighted.</p>
      <div id="comparisonSelectors" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px"></div>
      <button class="btn btn-ghost btn-sm" onclick="addComparisonSlot()" id="addCompBtn">+ Add Language</button>
      <div id="comparisonResults" style="margin-top:20px"></div>
    </div>
    <div id="tool-timeline" class="tool-panel" role="tabpanel">
      <div class="tool-h">Historical Timeline</div>
      <p class="tool-sub">Extinct and historical languages across time. Filter by family.</p>
      <div style="max-width:300px;margin-bottom:20px"><div class="field-label">Filter by Family</div><select class="sel" id="timelineFamily" style="width:100%"><option value="">All Families</option></select></div>
      <div id="timelineResults"></div>
    </div>
    <div id="tool-stats" class="tool-panel" role="tabpanel">
      <div class="tool-h">World Language Statistics</div>
      <p class="tool-sub">Global overview of language diversity, distribution, and endangerment.</p>
      <div id="worldStats"></div>
    </div>
  </section>

  <!-- KNOWLEDGE -->
  <section id="view-knowledge" class="view">
    <div class="sec-head"><h2>Sources &amp; Methodology</h2><p>Data provenance, scoring methodology, and academic references.</p></div>
    <div class="know-sec">
      <div class="know-sec-title">Data Sources</div>
      <div class="source-grid">
        <div class="source-card"><div class="source-name">Glottolog</div><p class="source-desc">Comprehensive catalogue of the world's languages, language families, and dialects. Provides ISO 639-3 codes, geographic coordinates, and family classification.</p><span class="source-url">glottolog.org</span></div>
        <div class="source-card"><div class="source-name">WALS ‚Äî World Atlas of Language Structures</div><p class="source-desc">Database of structural properties of languages. Primary source for typological features like word order, morphological type, and case alignment.</p><span class="source-url">wals.info</span></div>
        <div class="source-card"><div class="source-name">PHOIBLE</div><p class="source-desc">Repository of cross-linguistic phonological inventory data. Source for consonant/vowel inventory sizes, click sounds, ejectives, and tonal information.</p><span class="source-url">phoible.org</span></div>
        <div class="source-card"><div class="source-name">UNESCO Atlas of World's Languages in Danger</div><p class="source-desc">Classification of languages by endangerment: vulnerable, definitely endangered, severely endangered, critically endangered, and extinct.</p><span class="source-url">unesco.org/languages-atlas</span></div>
        <div class="source-card"><div class="source-name">Ethnologue</div><p class="source-desc">Reference publication cataloging all known living languages. Source for speaker population estimates, country-level distribution, and EGIDS vitality levels.</p><span class="source-url">ethnologue.com</span></div>
        <div class="source-card"><div class="source-name">Academic Literature</div><p class="source-desc">Mutual intelligibility scores from Gooskens (2007), Tang &amp; van Heuven (2009), and Golubovic &amp; Gooskens (2020).</p></div>
      </div>
    </div>
    <div class="know-sec">
      <div class="know-sec-title">Grammatical Similarity Score</div>
      <div style="background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);max-width:700px">
        <div class="tbl-scroll">
          <table class="comp-table">
            <thead><tr><th>Feature</th><th>Weight</th><th>Rationale</th></tr></thead>
            <tbody>
              <tr><td>Word Order</td><td>15%</td><td>SOV, SVO, VSO, etc.</td></tr>
              <tr><td>Morphological Type</td><td>15%</td><td>Isolating, agglutinative, fusional, polysynthetic</td></tr>
              <tr><td>Case Alignment</td><td>12%</td><td>Nominative-accusative, ergative-absolutive, etc.</td></tr>
              <tr><td>Case Count</td><td>8%</td><td>Number of grammatical cases</td></tr>
              <tr><td>Tone System</td><td>10%</td><td>None, simple, complex</td></tr>
              <tr><td>Gender System</td><td>8%</td><td>None, 2-gender, 3-gender, classifier, noun class</td></tr>
              <tr><td>Evidentiality</td><td>7%</td><td>Grammaticalized source-of-information marking</td></tr>
              <tr><td>Vowel Harmony</td><td>5%</td><td>Presence of vowel harmony system</td></tr>
              <tr><td>Consonant Inventory</td><td>5%</td><td>Small, average, large, very large</td></tr>
              <tr><td>Vowel Inventory</td><td>5%</td><td>Small, average, large</td></tr>
              <tr><td>Definiteness</td><td>5%</td><td>Article system type</td></tr>
              <tr><td>Negation Type</td><td>5%</td><td>Negation strategy</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="know-sec">
      <div class="know-sec-title">Mutual Intelligibility Scores</div>
      <div style="background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px;max-width:700px;font-size:13px;color:var(--ink-mid);line-height:1.65">
        Scores represent the percentage of content a listener can understand without prior study. Scores are <strong style="color:var(--ink)">directional</strong> ‚Äî a Portuguese speaker may understand more Spanish than vice versa.
        Categories: <strong style="color:var(--ink)">Very High</strong> (80%+), <strong style="color:var(--ink)">High</strong> (60‚Äì79%), <strong style="color:var(--ink)">Moderate</strong> (40‚Äì59%), <strong style="color:var(--ink)">Low</strong> (20‚Äì39%), <strong style="color:var(--ink)">Minimal</strong> (&lt;20%).
      </div>
    </div>
  </section>

</div><!-- /views-wrap -->

<footer class="site-footer">
  GlossaForge ‚Äî Data from Glottolog ¬∑ WALS ¬∑ PHOIBLE ¬∑ UNESCO Atlas
</footer>

<!-- DATA -->
<script src="data/families.js"></script>
<script src="data/languages.js"></script>
<script src="data/intelligibility.js"></script>
<script src="data/countries.js"></script>

<!-- APP -->
<script>
'use strict';

let currentView = 'home';
let leafletMap = null;
let mapMarkers = [];
let mapLayerMode = 'family';
let comparisonSlots = [];
let viewsLoaded = { home: true };
let explorerActiveChips = [];
let darkTiles, lightTiles;

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
(function() {
  const saved = localStorage.getItem('gf-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  const btn = document.getElementById('themeToggle');
  btn.textContent = saved === 'light' ? '‚òÄÔ∏è' : 'üåô';
  btn.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme');
    const nxt = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', nxt);
    localStorage.setItem('gf-theme', nxt);
    btn.textContent = nxt === 'light' ? '‚òÄÔ∏è' : 'üåô';
    if (leafletMap) updateMapTiles();
  });
})();

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function switchToView(viewId) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.pn, .mob-link').forEach(l => l.classList.remove('active'));
  const target = document.getElementById('view-' + viewId);
  if (target) { target.classList.add('active'); currentView = viewId; }
  document.querySelectorAll('[data-view="' + viewId + '"]').forEach(l => l.classList.add('active'));
  if (viewId === 'map') {
    // Critical Leaflet fix: invalidate after display:none -> display:block transition
    requestAnimationFrame(() => { if (leafletMap) leafletMap.invalidateSize(); });
  } else {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  if (!viewsLoaded[viewId]) lazyLoadView(viewId);
}

document.querySelectorAll('[data-view]').forEach(el => {
  el.addEventListener('click', () => switchToView(el.dataset.view));
});

function lazyLoadView(id) {
  viewsLoaded[id] = true;
  if (id === 'map') initMap();
  else if (id === 'explorer') initExplorer();
  else if (id === 'families') initFamilyTree();
  else if (id === 'tools') initTools();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function fmtNum(n) {
  if (n >= 1e9) return (n/1e9).toFixed(1)+'B';
  if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
  return String(n||0);
}
function getAllLangs() { return typeof LANGUAGE_DATABASE!=='undefined' ? Object.values(LANGUAGE_DATABASE) : []; }
function getFamilyName(id) { return (typeof FAMILY_TREE!=='undefined'&&FAMILY_TREE[id]) ? FAMILY_TREE[id].name : id; }
const FHEX = {indoEuropean:'#60a5fa',sinoTibetan:'#f87171',nigerCongo:'#34d399',afroasiatic:'#fbbf24',austronesian:'#a78bfa',dravidian:'#fb923c',turkic:'#22d3ee',uralic:'#e879f9',japonic:'#f472b6',koreanic:'#818cf8',taiKadai:'#2dd4bf',austroasiatic:'#a3e635'};
function getFamilyHex(id) { return FHEX[id] || '#71717a'; }
function endangerBadge(s) {
  const m = {safe:['Safe','badge-safe'],vulnerable:['Vulnerable','badge-vulnerable'],definitely_endangered:['Endangered','badge-endangered'],severely_endangered:['Severely End.','badge-severely'],critically_endangered:['Critical','badge-critical'],extinct:['Extinct','badge-extinct']};
  const [l,c] = m[s]||['‚Äî',''];
  return `<span class="badge ${c}">${l}</span>`;
}

// ‚îÄ‚îÄ HOME STATS ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  const langs = getAllLangs();
  if (langs.length) {
    document.getElementById('statLangs').textContent = langs.length;
    document.getElementById('statFamilies').textContent = new Set(langs.map(l=>l.family)).size;
    document.getElementById('statSpeakers').textContent = fmtNum(langs.reduce((s,l)=>s+(l.totalSpeakers||l.l1Speakers||0),0));
    document.getElementById('statEndangered').textContent = langs.filter(l=>l.unescoStatus&&l.unescoStatus!=='safe'&&l.unescoStatus!=='extinct').length;
    document.getElementById('statExtinct').textContent = langs.filter(l=>l.isExtinct||l.unescoStatus==='extinct').length;
  }
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
});

// ‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê
function initMap() {
  if (leafletMap) { setTimeout(()=>leafletMap.invalidateSize(),50); return; }
  leafletMap = L.map('mapContainer',{zoomControl:false,attributionControl:false}).setView([20,0],2);
  L.control.zoom({position:'bottomright'}).addTo(leafletMap);
  L.control.attribution({position:'bottomright',prefix:false}).addTo(leafletMap);
  darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:18});
  lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:18});
  (document.documentElement.getAttribute('data-theme')!=='light' ? darkTiles : lightTiles).addTo(leafletMap);
  populateMapFilters();
  renderMapMarkers();
  renderMapLegend();
  setupMapEvents();
  // Double invalidate ‚Äî catches both immediate and post-transition layout
  setTimeout(()=>leafletMap.invalidateSize(),100);
  setTimeout(()=>leafletMap.invalidateSize(),500);
}

function updateMapTiles() {
  if (!leafletMap) return;
  if (document.documentElement.getAttribute('data-theme')!=='light') { leafletMap.removeLayer(lightTiles); darkTiles.addTo(leafletMap); }
  else { leafletMap.removeLayer(darkTiles); lightTiles.addTo(leafletMap); }
}

function populateMapFilters() {
  const langs = getAllLangs();
  const add = (id, arr, lFn) => { const s=document.getElementById(id); arr.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=lFn?lFn(v):v;s.appendChild(o)}); };
  add('mapFamily',[...new Set(langs.map(l=>l.family))].sort(),getFamilyName);
  add('mapRegion',[...new Set(langs.map(l=>l.macroRegion).filter(Boolean))].sort());
  add('mapWordOrder',[...new Set(langs.map(l=>l.wordOrder).filter(Boolean))].sort());
  add('mapMorphType',[...new Set(langs.map(l=>l.morphType).filter(Boolean))].sort());
  add('mapTone',[...new Set(langs.map(l=>l.toneSystem).filter(Boolean))].sort());
}

function getMapFiltered() {
  let langs = getAllLangs();
  const q = v => document.getElementById(v).value;
  const search = q('mapSearch').toLowerCase().trim();
  const extinct = document.getElementById('mapShowExtinct').checked;
  if (!extinct) langs = langs.filter(l=>!l.isExtinct&&l.unescoStatus!=='extinct');
  if (search) langs = langs.filter(l=>l.name.toLowerCase().includes(search)||l.id.toLowerCase().includes(search)||(l.nativeName&&l.nativeName.toLowerCase().includes(search))||(l.alternateNames&&l.alternateNames.some(a=>a.toLowerCase().includes(search))));
  if (q('mapFamily')) langs=langs.filter(l=>l.family===q('mapFamily'));
  if (q('mapRegion')) langs=langs.filter(l=>l.macroRegion===q('mapRegion'));
  if (q('mapWordOrder')) langs=langs.filter(l=>l.wordOrder===q('mapWordOrder'));
  if (q('mapMorphType')) langs=langs.filter(l=>l.morphType===q('mapMorphType'));
  if (q('mapEndangerment')) langs=langs.filter(l=>l.unescoStatus===q('mapEndangerment'));
  if (q('mapTone')) langs=langs.filter(l=>l.toneSystem===q('mapTone'));
  return langs;
}

function getMarkerColor(l) {
  if (mapLayerMode==='family') return getFamilyHex(l.family);
  if (mapLayerMode==='endangerment') return ({safe:'#34d399',vulnerable:'#fbbf24',definitely_endangered:'#fb923c',severely_endangered:'#f87171',critically_endangered:'#ef4444',extinct:'#52525b'})[l.unescoStatus]||'#71717a';
  if (mapLayerMode==='wordorder') return ({SOV:'#60a5fa',SVO:'#34d399',VSO:'#fbbf24',VOS:'#f87171',OVS:'#a78bfa',OSV:'#fb923c'})[l.wordOrder]||'#71717a';
  if (mapLayerMode==='morphology') return ({isolating:'#60a5fa',agglutinative:'#34d399',fusional:'#fbbf24',polysynthetic:'#f87171',introflexive:'#a78bfa'})[l.morphType]||'#71717a';
  if (mapLayerMode==='tone') return ({none:'#71717a',simple:'#fbbf24',complex:'#f87171'})[l.toneSystem]||'#71717a';
  return '#71717a';
}

function renderMapMarkers() {
  mapMarkers.forEach(m=>leafletMap.removeLayer(m)); mapMarkers=[];
  const langs=getMapFiltered();
  document.getElementById('mapFilterCount').textContent=langs.length+' language'+(langs.length!==1?'s':'')+' shown';
  langs.forEach(lang=>{
    if (!lang.lat||!lang.lon) return;
    const r=Math.max(4,Math.min(14,Math.log10(lang.totalSpeakers||lang.l1Speakers||1000)*2));
    const col=getMarkerColor(lang);
    const m=L.circleMarker([lang.lat,lang.lon],{radius:r,fillColor:col,color:col,weight:1,opacity:.85,fillOpacity:.5});
    m.bindPopup(`<div class="map-popup">
      <h3>${lang.name}</h3>
      ${lang.nativeName&&lang.nativeName!==lang.name?`<div style="color:var(--ink-low);font-size:11px;margin-bottom:4px">${lang.nativeName}</div>`:''}
      <div class="popup-family" style="color:${col}">${getFamilyName(lang.family)}</div>
      <div class="popup-row"><span>ISO 639-3</span><span style="font-family:var(--font-mono)">${lang.id}</span></div>
      <div class="popup-row"><span>L1 Speakers</span><span>${fmtNum(lang.l1Speakers||0)}</span></div>
      <div class="popup-row"><span>Total Speakers</span><span>${fmtNum(lang.totalSpeakers||lang.l1Speakers||0)}</span></div>
      <div class="popup-row"><span>Status</span><span>${lang.unescoStatus||'‚Äî'}</span></div>
      <div class="popup-row"><span>Word Order</span><span>${lang.wordOrder||'‚Äî'}</span></div>
      <div class="popup-row"><span>Morphology</span><span>${lang.morphType||'‚Äî'}</span></div>
      <a class="popup-link" href="#" onclick="event.preventDefault();switchToView('explorer');showLangDetail('${lang.id}')">Full Profile ‚Üí</a>
    </div>`,{maxWidth:260});
    m.addTo(leafletMap); mapMarkers.push(m);
  });
}

function renderMapLegend() {
  const lg=document.getElementById('mapLegend');
  let rows=[];
  if (mapLayerMode==='family') {
    (typeof FAMILY_TREE!=='undefined'?Object.values(FAMILY_TREE):[]).slice(0,12).forEach(f=>rows.push(`<div class="legend-row"><div class="legend-dot" style="background:${f.color}"></div>${f.name}</div>`));
    rows.push(`<div class="legend-row"><div class="legend-dot" style="background:#71717a"></div>Other</div>`);
  } else if (mapLayerMode==='endangerment') {
    [['#34d399','Safe'],['#fbbf24','Vulnerable'],['#fb923c','Endangered'],['#f87171','Severely End.'],['#ef4444','Critical'],['#52525b','Extinct']].forEach(([c,l])=>rows.push(`<div class="legend-row"><div class="legend-dot" style="background:${c}"></div>${l}</div>`));
  } else if (mapLayerMode==='wordorder') {
    [['#60a5fa','SOV'],['#34d399','SVO'],['#fbbf24','VSO'],['#f87171','VOS'],['#a78bfa','OVS'],['#fb923c','OSV']].forEach(([c,l])=>rows.push(`<div class="legend-row"><div class="legend-dot" style="background:${c}"></div>${l}</div>`));
  } else if (mapLayerMode==='morphology') {
    [['#60a5fa','Isolating'],['#34d399','Agglutinative'],['#fbbf24','Fusional'],['#f87171','Polysynthetic']].forEach(([c,l])=>rows.push(`<div class="legend-row"><div class="legend-dot" style="background:${c}"></div>${l}</div>`));
  } else if (mapLayerMode==='tone') {
    [['#71717a','No Tone'],['#fbbf24','Simple'],['#f87171','Complex']].forEach(([c,l])=>rows.push(`<div class="legend-row"><div class="legend-dot" style="background:${c}"></div>${l}</div>`));
  }
  lg.innerHTML=`<div class="legend-title">${mapLayerMode.charAt(0).toUpperCase()+mapLayerMode.slice(1)}</div>${rows.join('')}`;
}

function setupMapEvents() {
  ['mapSearch','mapFamily','mapRegion','mapWordOrder','mapMorphType','mapEndangerment','mapTone'].forEach(id=>{
    document.getElementById(id).addEventListener(id==='mapSearch'?'input':'change',renderMapMarkers);
  });
  document.getElementById('mapShowExtinct').addEventListener('change',renderMapMarkers);
  document.querySelectorAll('.map-layer-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.map-layer-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); mapLayerMode=btn.dataset.layer;
      renderMapMarkers(); renderMapLegend();
    });
  });
}

function resetMapFilters() {
  ['mapSearch','mapFamily','mapRegion','mapWordOrder','mapMorphType','mapEndangerment','mapTone'].forEach(id=>{document.getElementById(id).value='';});
  document.getElementById('mapShowExtinct').checked=false;
  renderMapMarkers();
}

// ‚ïê‚ïê‚ïê EXPLORER ‚ïê‚ïê‚ïê
function initExplorer() {
  const langs=getAllLangs();
  const add=(id,arr,lFn)=>{const s=document.getElementById(id);arr.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=lFn?lFn(v):v;s.appendChild(o)});};
  add('explorerFamily',[...new Set(langs.map(l=>l.family))].sort(),getFamilyName);
  add('explorerRegion',[...new Set(langs.map(l=>l.macroRegion).filter(Boolean))].sort());
  const qf=['SVO','SOV','VSO','Tonal','Agglutinative','Fusional','Polysynthetic','Has Clicks','Has Ejectives'];
  document.getElementById('explorerChips').innerHTML=qf.map(q=>`<button class="chip" onclick="toggleChip(this,'${q}')">${q}</button>`).join('');
  ['explorerSearch','explorerFamily','explorerRegion','explorerEndanger'].forEach(id=>{
    document.getElementById(id).addEventListener(id==='explorerSearch'?'input':'change',renderExplorerResults);
  });
  renderExplorerResults();
}

function toggleChip(el,f) {
  el.classList.toggle('active');
  if (el.classList.contains('active')) explorerActiveChips.push(f);
  else explorerActiveChips=explorerActiveChips.filter(x=>x!==f);
  renderExplorerResults();
}

function getExplorerFiltered() {
  let langs=getAllLangs();
  const q=id=>document.getElementById(id).value;
  const search=q('explorerSearch').toLowerCase().trim();
  if (search) langs=langs.filter(l=>l.name.toLowerCase().includes(search)||l.id.toLowerCase().includes(search)||(l.nativeName&&l.nativeName.toLowerCase().includes(search))||(l.alternateNames&&l.alternateNames.some(a=>a.toLowerCase().includes(search))));
  if (q('explorerFamily')) langs=langs.filter(l=>l.family===q('explorerFamily'));
  if (q('explorerRegion')) langs=langs.filter(l=>l.macroRegion===q('explorerRegion'));
  if (q('explorerEndanger')) langs=langs.filter(l=>l.unescoStatus===q('explorerEndanger'));
  explorerActiveChips.forEach(chip=>{
    if (chip==='SVO') langs=langs.filter(l=>l.wordOrder==='SVO');
    else if (chip==='SOV') langs=langs.filter(l=>l.wordOrder==='SOV');
    else if (chip==='VSO') langs=langs.filter(l=>l.wordOrder==='VSO');
    else if (chip==='Tonal') langs=langs.filter(l=>l.toneSystem&&l.toneSystem!=='none');
    else if (chip==='Agglutinative') langs=langs.filter(l=>l.morphType==='agglutinative');
    else if (chip==='Fusional') langs=langs.filter(l=>l.morphType==='fusional');
    else if (chip==='Polysynthetic') langs=langs.filter(l=>l.morphType==='polysynthetic');
    else if (chip==='Has Clicks') langs=langs.filter(l=>l.hasClicks);
    else if (chip==='Has Ejectives') langs=langs.filter(l=>l.hasEjectives);
  });
  return langs;
}

function renderExplorerResults() {
  const langs=getExplorerFiltered();
  document.getElementById('explorerCount').textContent=langs.length+' language'+(langs.length!==1?'s':'')+' found';
  const toShow=langs.slice(0,60);
  document.getElementById('explorerResults').innerHTML=toShow.map(l=>`
    <div class="lang-card" onclick="showLangDetail('${l.id}')" tabindex="0" role="button">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">
        <div><div class="lang-name">${l.name}</div>${l.nativeName&&l.nativeName!==l.name?`<div class="lang-native">${l.nativeName}</div>`:''}</div>
        <span class="lang-iso">${l.id}</span>
      </div>
      <div class="lang-badges">
        <span class="fam-tag" style="background:${getFamilyHex(l.family)}18;color:${getFamilyHex(l.family)}">${getFamilyName(l.family)}</span>
        ${endangerBadge(l.unescoStatus)}
      </div>
      <div class="lang-foot"><span>${fmtNum(l.totalSpeakers||l.l1Speakers||0)} speakers</span><span>${l.wordOrder||'‚Äî'} ¬∑ ${l.morphType||'‚Äî'}</span></div>
    </div>
  `).join('')+(langs.length>60?`<div style="text-align:center;padding:20px;color:var(--ink-low);font-size:13px;grid-column:1/-1">Showing 60 of ${langs.length} ‚Äî refine search to see more</div>`:'');
}

function showLangDetail(langId) {
  const lang=typeof LANGUAGE_DATABASE!=='undefined'?LANGUAGE_DATABASE[langId]:null;
  if (!lang) return;
  document.getElementById('explorerResults').style.display='none';
  document.getElementById('explorerCount').style.display='none';
  document.getElementById('explorerChips').style.display='none';
  document.querySelector('.explorer-top').style.display='none';
  const countries=(lang.countries||[]).map(c=>(typeof COUNTRY_DATA!=='undefined'&&COUNTRY_DATA[c])?COUNTRY_DATA[c].name:c);
  const officialIn=(lang.officialIn||[]).map(c=>(typeof COUNTRY_DATA!=='undefined'&&COUNTRY_DATA[c])?COUNTRY_DATA[c].name:c);
  const d=document.getElementById('explorerDetail');
  d.style.display='block';
  d.innerHTML=`<div class="detail-wrap">
    <button class="detail-back" onclick="closeLangDetail()">‚Üê Back to results</button>
    <div class="detail-name">${lang.name}</div>
    ${lang.nativeName&&lang.nativeName!==lang.name?`<div class="detail-sub">${lang.nativeName}</div>`:''}
    ${lang.alternateNames&&lang.alternateNames.length?`<div class="detail-alts">Also: ${lang.alternateNames.join(', ')}</div>`:''}
    <div class="detail-tags">
      <span class="fam-tag" style="background:${getFamilyHex(lang.family)}18;color:${getFamilyHex(lang.family)};padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600">${getFamilyName(lang.family)}</span>
      ${endangerBadge(lang.unescoStatus)}
      ${lang.isUNLanguage?'<span class="badge" style="background:rgba(0,212,255,.1);color:var(--cyan)">UN Language</span>':''}
      ${lang.isEULanguage?'<span class="badge" style="background:rgba(0,212,255,.1);color:var(--cyan)">EU Language</span>':''}
    </div>
    <div class="detail-sec"><div class="detail-sec-title">Classification</div><div class="detail-grid">
      <div class="detail-field"><div class="detail-lbl">ISO 639-3</div><div class="detail-val" style="font-family:var(--font-mono)">${lang.id}</div></div>
      ${lang.iso639_1?`<div class="detail-field"><div class="detail-lbl">ISO 639-1</div><div class="detail-val" style="font-family:var(--font-mono)">${lang.iso639_1}</div></div>`:''}
      <div class="detail-field"><div class="detail-lbl">Family</div><div class="detail-val">${getFamilyName(lang.family)}</div></div>
      <div class="detail-field"><div class="detail-lbl">Branch</div><div class="detail-val">${lang.branch||'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Sub-branch</div><div class="detail-val">${lang.subbranch||'‚Äî'}</div></div>
    </div></div>
    <div class="detail-sec"><div class="detail-sec-title">Demographics</div><div class="detail-grid">
      <div class="detail-field"><div class="detail-lbl">L1 Speakers</div><div class="detail-val">${(lang.l1Speakers||0).toLocaleString()}</div></div>
      <div class="detail-field"><div class="detail-lbl">L2 Speakers</div><div class="detail-val">${(lang.l2Speakers||0).toLocaleString()}</div></div>
      <div class="detail-field"><div class="detail-lbl">Total Speakers</div><div class="detail-val">${(lang.totalSpeakers||lang.l1Speakers||0).toLocaleString()}</div></div>
      <div class="detail-field"><div class="detail-lbl">Region</div><div class="detail-val">${lang.macroRegion||'‚Äî'}</div></div>
    </div></div>
    ${countries.length||officialIn.length?`<div class="detail-sec"><div class="detail-sec-title">Geography & Legal Status</div><div class="detail-grid">
      ${countries.length?`<div class="detail-field" style="grid-column:1/-1"><div class="detail-lbl">Countries</div><div class="detail-val">${countries.join(', ')}</div></div>`:''}
      ${officialIn.length?`<div class="detail-field" style="grid-column:1/-1"><div class="detail-lbl">Official In</div><div class="detail-val">${officialIn.join(', ')}</div></div>`:''}
    </div></div>`:''}
    <div class="detail-sec"><div class="detail-sec-title">Typological Features</div><div class="detail-grid">
      <div class="detail-field"><div class="detail-lbl">Word Order</div><div class="detail-val">${lang.wordOrder||'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Morphological Type</div><div class="detail-val">${lang.morphType||'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Case Alignment</div><div class="detail-val">${(lang.caseAlignment||'‚Äî').replace(/_/g,'-')}</div></div>
      <div class="detail-field"><div class="detail-lbl">Case Count</div><div class="detail-val">${lang.caseCount??'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Tone System</div><div class="detail-val">${lang.toneSystem||'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Gender System</div><div class="detail-val">${(lang.genderSystem||'‚Äî').replace(/_/g,' ')}</div></div>
      <div class="detail-field"><div class="detail-lbl">Evidentiality</div><div class="detail-val">${lang.evidentiality||'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Vowel Harmony</div><div class="detail-val">${lang.hasVowelHarmony?'Yes':'No'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Clicks</div><div class="detail-val">${lang.hasClicks?'Yes':'No'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Ejectives</div><div class="detail-val">${lang.hasEjectives?'Yes':'No'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Nasal Vowels</div><div class="detail-val">${lang.hasNasalVowels?'Yes':'No'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Consonant Inventory</div><div class="detail-val">${lang.consonantInventory||'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Vowel Inventory</div><div class="detail-val">${lang.vowelInventory||'‚Äî'}</div></div>
      <div class="detail-field"><div class="detail-lbl">Definiteness</div><div class="detail-val">${(lang.definiteness||'‚Äî').replace(/_/g,' ')}</div></div>
      <div class="detail-field"><div class="detail-lbl">Negation</div><div class="detail-val">${(lang.negationType||'‚Äî').replace(/_/g,' ')}</div></div>
    </div></div>
    ${lang.scripts&&lang.scripts.length?`<div class="detail-sec"><div class="detail-sec-title">Writing Systems</div><div class="detail-grid">
      ${lang.scripts.map(s=>`<div class="detail-field"><div class="detail-lbl">${s.name}${s.isPrimary?' (primary)':''}</div><div class="detail-val">${s.type} ¬∑ ${s.direction.toUpperCase()}</div></div>`).join('')}
    </div></div>`:''}
  </div>`;
  window.scrollTo({top:0,behavior:'smooth'});
}

function closeLangDetail() {
  document.getElementById('explorerDetail').style.display='none';
  document.getElementById('explorerResults').style.display='';
  document.getElementById('explorerCount').style.display='';
  document.getElementById('explorerChips').style.display='';
  document.querySelector('.explorer-top').style.display='';
}

// ‚ïê‚ïê‚ïê FAMILIES ‚ïê‚ïê‚ïê
function initFamilyTree() {
  if (typeof FAMILY_TREE==='undefined') return;
  const top5=Object.values(FAMILY_TREE).sort((a,b)=>(b.speakers||0)-(a.speakers||0)).slice(0,5);
  document.getElementById('familyStats').innerHTML=top5.map(f=>`<div class="stat-cell"><div class="stat-val" style="color:${f.color};font-size:1.3rem">${fmtNum(f.speakers||0)}</div><div class="stat-lbl">${f.name}</div></div>`).join('');
  renderFamilyTree();
  document.getElementById('familySearch').addEventListener('input',renderFamilyTree);
}

function countBL(branches) {
  let n=0; if (!branches) return 0;
  Object.values(branches).forEach(b=>{if(b.languages)n+=b.languages.length;if(b.branches)n+=countBL(b.branches)});
  return n;
}

function renderFamilyTree() {
  const search=document.getElementById('familySearch').value.toLowerCase().trim();
  document.getElementById('familyTree').innerHTML=Object.values(FAMILY_TREE).map(fam=>{
    const lc=countBL(fam.branches);
    if (search&&!fam.name.toLowerCase().includes(search)&&!bmatch(fam.branches,search)) return '';
    return `<div class="tree-fam">
      <div class="tree-fam-head" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.tree-chevron').classList.toggle('open')">
        <div class="tree-fam-left"><div class="tree-dot" style="background:${fam.color}"></div>${fam.name}<span class="tree-chevron">‚ñ∂</span></div>
        <div class="tree-fam-stats"><span>${lc} langs</span><span>${fmtNum(fam.speakers||0)} speakers</span></div>
      </div>
      <div class="tree-body">${fam.branches?renderBranches(fam.branches,search):''}</div>
    </div>`;
  }).join('');
}

function renderBranches(branches,search) {
  return Object.values(branches).map(b=>{
    const hasSub=b.branches&&Object.keys(b.branches).length>0;
    const langs=b.languages||[];
    if (search&&!b.name.toLowerCase().includes(search)&&!bmatch(b.branches,search)&&!langs.some(id=>{const l=typeof LANGUAGE_DATABASE!=='undefined'?LANGUAGE_DATABASE[id]:null;return l&&l.name.toLowerCase().includes(search)})) return '';
    return `<div class="tree-branch">
      <div class="tree-branch-head" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.tree-chevron').classList.toggle('open')">
        <span class="tree-chevron" style="font-size:9px;color:var(--ink-low)">‚ñ∂</span>
        ${b.name}
        <span style="font-size:11px;color:var(--ink-dim);margin-left:auto">${hasSub?countBL(b.branches)+langs.length:langs.length}</span>
      </div>
      <div class="tree-sub-body">
        ${hasSub?renderBranches(b.branches,search):''}
        ${langs.map(id=>{
          const l=typeof LANGUAGE_DATABASE!=='undefined'?LANGUAGE_DATABASE[id]:null;
          if (search&&l&&!l.name.toLowerCase().includes(search)) return '';
          return `<div class="tree-lang" onclick="switchToView('explorer');showLangDetail('${id}')"><span>${l?l.name:id}</span><span class="tree-lang-iso">${id}</span></div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

function bmatch(branches,search) {
  if (!branches) return false;
  return Object.values(branches).some(b=>
    b.name.toLowerCase().includes(search)||
    (b.languages||[]).some(id=>{const l=typeof LANGUAGE_DATABASE!=='undefined'?LANGUAGE_DATABASE[id]:null;return l&&l.name.toLowerCase().includes(search)})||
    bmatch(b.branches,search)
  );
}

// ‚ïê‚ïê‚ïê TOOLS ‚ïê‚ïê‚ïê
function initTools() {
  document.querySelectorAll('.tool-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.tool-tab').forEach(t=>{t.classList.remove('active');t.setAttribute('aria-selected','false')});
      document.querySelectorAll('.tool-panel').forEach(p=>p.classList.remove('active'));
      tab.classList.add('active'); tab.setAttribute('aria-selected','true');
      document.getElementById('tool-'+tab.dataset.tool).classList.add('active');
    });
  });
  const langs=getAllLangs().filter(l=>!l.isExtinct).sort((a,b)=>a.name.localeCompare(b.name));
  ['intelligibilityLang','similarityLang'].forEach(id=>{
    const s=document.getElementById(id);
    langs.forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=`${l.name} [${l.id}]`;s.appendChild(o)});
  });
  if (typeof FAMILY_TREE!=='undefined') {
    const s=document.getElementById('timelineFamily');
    Object.values(FAMILY_TREE).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent=f.name;s.appendChild(o)});
  }
  document.getElementById('intelligibilityLang').addEventListener('change',runIntelligibility);
  document.getElementById('similarityLang').addEventListener('change',runSimilarity);
  document.getElementById('timelineFamily').addEventListener('change',runTimeline);
  initComparisonSlots(); runWorldStats(); runTimeline();
}

function runIntelligibility() {
  const id=document.getElementById('intelligibilityLang').value;
  const c=document.getElementById('intelligibilityResults');
  if (!id){c.innerHTML='';return}
  if (typeof INTELLIGIBILITY_EDGES==='undefined'){c.innerHTML='<p style="color:var(--ink-low)">Data not loaded.</p>';return}
  const edges=INTELLIGIBILITY_EDGES.filter(e=>e.source===id||e.target===id);
  if (!edges.length){c.innerHTML='<p style="color:var(--ink-low)">No intelligibility data for this language.</p>';return}
  const lang=LANGUAGE_DATABASE[id];
  c.innerHTML=edges.map(e=>{
    const othId=e.source===id?e.target:e.source;
    const oth=LANGUAGE_DATABASE[othId]; if (!oth) return '';
    const fwd=e.source===id?e.score:e.reverse;
    const rev=e.source===id?e.reverse:e.score;
    const col=fwd>=.8?'var(--safe)':fwd>=.6?'var(--vuln)':fwd>=.4?'var(--endanger)':'var(--severe)';
    return `<div class="res-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><span style="font-weight:600;font-size:14px">${oth.name}</span><span style="font-family:var(--font-mono);font-size:10px;color:var(--ink-low);margin-left:8px">${othId}</span></div>
        <span class="badge" style="background:${col}18;color:${col}">${e.category.replace(/_/g,' ')}</span>
      </div>
      <div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--ink-low);margin-bottom:4px"><span>${lang.name} ‚Üí ${oth.name}</span><span style="color:var(--ink)">${Math.round(fwd*100)}%</span></div>
        <div class="bar-wrap"><div class="bar-fill" style="width:${fwd*100}%;background:${col}"></div></div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--ink-low);margin-bottom:4px"><span>${oth.name} ‚Üí ${lang.name}</span><span style="color:var(--ink)">${Math.round(rev*100)}%</span></div>
        <div class="bar-wrap"><div class="bar-fill" style="width:${rev*100}%;background:${col}"></div></div>
      </div>
      <div style="font-size:11px;color:var(--ink-low);margin-top:8px">Modality: ${e.modality||'spoken'}</div>
    </div>`;
  }).join('');
}

function runSimilarity() {
  const id=document.getElementById('similarityLang').value;
  const c=document.getElementById('similarityResults');
  if (!id){c.innerHTML='';return}
  const lang=LANGUAGE_DATABASE[id];
  const features=[{key:'wordOrder',w:15},{key:'morphType',w:15},{key:'caseAlignment',w:12},{key:'toneSystem',w:10},{key:'genderSystem',w:8},{key:'evidentiality',w:7},{key:'consonantInventory',w:5},{key:'vowelInventory',w:5},{key:'definiteness',w:5},{key:'negationType',w:5}];
  const bools=[{key:'hasVowelHarmony',w:5},{key:'hasClicks',w:3},{key:'hasEjectives',w:3},{key:'hasNasalVowels',w:2}];
  const scores=getAllLangs().filter(l=>l.id!==id&&!l.isExtinct).map(oth=>{
    let sc=0,tot=0;
    features.forEach(f=>{if(lang[f.key]&&oth[f.key]){tot+=f.w;if(lang[f.key]===oth[f.key])sc+=f.w}});
    bools.forEach(f=>{tot+=f.w;if(lang[f.key]===oth[f.key])sc+=f.w});
    if(lang.caseCount!=null&&oth.caseCount!=null){tot+=8;const d=Math.abs(lang.caseCount-oth.caseCount);if(d===0)sc+=8;else if(d<=2)sc+=5;else if(d<=5)sc+=2}
    return {lang:oth,score:tot>0?sc/tot:0};
  }).sort((a,b)=>b.score-a.score).slice(0,20);
  c.innerHTML=`<div style="margin-bottom:14px;font-size:13px;color:var(--ink-mid)">Most grammatically similar to <strong style="color:var(--ink)">${lang.name}</strong></div>`+
  scores.map((item,i)=>{
    const col=item.score>=.8?'var(--safe)':item.score>=.6?'var(--cyan)':item.score>=.4?'var(--vuln)':'var(--ink-low)';
    return `<div class="res-card" style="display:flex;align-items:center;gap:12px">
      <div style="font-family:var(--font-mono);font-size:11px;color:var(--ink-dim);width:20px;text-align:right">${i+1}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
          <span style="font-weight:600;font-size:13px">${item.lang.name}</span>
          <span class="fam-tag" style="background:${getFamilyHex(item.lang.family)}18;color:${getFamilyHex(item.lang.family)};padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600">${getFamilyName(item.lang.family)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="bar-wrap"><div class="bar-fill" style="width:${item.score*100}%;background:${col}"></div></div>
          <span style="font-size:11px;color:${col};white-space:nowrap">${Math.round(item.score*100)}%</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function initComparisonSlots() { comparisonSlots=[]; addComparisonSlot(); addComparisonSlot(); }

function addComparisonSlot() {
  if (comparisonSlots.length>=5) return;
  const idx=comparisonSlots.length; comparisonSlots.push('');
  const div=document.createElement('div'); div.style.minWidth='170px';
  div.innerHTML=`<div class="field-label">Language ${idx+1}</div><select class="sel" id="comp-${idx}" onchange="comparisonSlots[${idx}]=this.value;renderComparison()"><option value="">Select‚Ä¶</option></select>`;
  document.getElementById('comparisonSelectors').appendChild(div);
  const s=div.querySelector('select');
  getAllLangs().filter(l=>!l.isExtinct).sort((a,b)=>a.name.localeCompare(b.name)).forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=l.name;s.appendChild(o)});
  if (comparisonSlots.length>=5) document.getElementById('addCompBtn').style.display='none';
}

function renderComparison() {
  const sel=comparisonSlots.filter(s=>s).map(id=>LANGUAGE_DATABASE[id]).filter(Boolean);
  const c=document.getElementById('comparisonResults');
  if (sel.length<2){c.innerHTML='<p style="color:var(--ink-low);font-size:13px">Select at least 2 languages to compare.</p>';return}
  const features=[
    {key:'family',lbl:'Family',fmt:v=>getFamilyName(v)},
    {key:'wordOrder',lbl:'Word Order'},{key:'morphType',lbl:'Morphological Type'},
    {key:'caseAlignment',lbl:'Case Alignment',fmt:v=>(v||'‚Äî').replace(/_/g,'-')},
    {key:'caseCount',lbl:'Case Count'},{key:'toneSystem',lbl:'Tone System'},
    {key:'genderSystem',lbl:'Gender System',fmt:v=>(v||'‚Äî').replace(/_/g,' ')},
    {key:'genderCount',lbl:'Gender Count'},{key:'evidentiality',lbl:'Evidentiality'},
    {key:'hasVowelHarmony',lbl:'Vowel Harmony',fmt:v=>v?'Yes':'No'},
    {key:'hasClicks',lbl:'Clicks',fmt:v=>v?'Yes':'No'},{key:'hasEjectives',lbl:'Ejectives',fmt:v=>v?'Yes':'No'},
    {key:'consonantInventory',lbl:'Consonant Inventory'},{key:'vowelInventory',lbl:'Vowel Inventory'},
    {key:'definiteness',lbl:'Definiteness',fmt:v=>(v||'‚Äî').replace(/_/g,' ')},
    {key:'negationType',lbl:'Negation',fmt:v=>(v||'‚Äî').replace(/_/g,' ')},
    {key:'l1Speakers',lbl:'L1 Speakers',fmt:v=>fmtNum(v||0)},{key:'totalSpeakers',lbl:'Total Speakers',fmt:v=>fmtNum(v||0)},
    {key:'unescoStatus',lbl:'Endangerment',fmt:v=>(v||'‚Äî').replace(/_/g,' ')}
  ];
  c.innerHTML=`<div class="tbl-scroll"><table class="comp-table"><thead><tr><th>Feature</th>${sel.map(l=>`<th>${l.name}</th>`).join('')}</tr></thead><tbody>
    ${features.map(f=>{const vals=sel.map(l=>f.fmt?f.fmt(l[f.key]):(l[f.key]??'‚Äî'));const same=vals.every(v=>v===vals[0])&&vals[0]!=='‚Äî';return `<tr${same?' class="match"':''}><td>${f.lbl}</td>${vals.map(v=>`<td>${v}</td>`).join('')}</tr>`;}).join('')}
  </tbody></table></div>`;
}

function runTimeline() {
  const fam=document.getElementById('timelineFamily').value;
  const c=document.getElementById('timelineResults');
  let langs=getAllLangs().filter(l=>l.isExtinct||l.unescoStatus==='extinct');
  if (fam) langs=langs.filter(l=>l.family===fam);
  langs.sort((a,b)=>(b.extinctionDate||0)-(a.extinctionDate||0));
  if (!langs.length){c.innerHTML='<p style="color:var(--ink-low);font-size:13px">No extinct languages for this filter.</p>';return}
  c.innerHTML=`<div style="margin-bottom:14px;font-size:12px;color:var(--ink-low)">${langs.length} extinct language${langs.length!==1?'s':''}</div>
  <div class="timeline">${langs.slice(0,40).map(l=>`
    <div class="tl-item"><div class="tl-dot" style="background:${getFamilyHex(l.family)}"></div>
    <div class="tl-period">${l.extinctionDate?`~${l.extinctionDate}`:'Date unknown'}</div>
    <div class="tl-name">${l.name}</div>
    <div class="tl-meta">${getFamilyName(l.family)} ¬∑ ${l.region||l.macroRegion||'‚Äî'}</div></div>
  `).join('')}</div>${langs.length>40?`<div style="color:var(--ink-low);font-size:12px;margin-top:12px">Showing 40 of ${langs.length}</div>`:''}`;
}

function runWorldStats() {
  const c=document.getElementById('worldStats');
  const langs=getAllLangs();
  if (!langs.length){c.innerHTML='<p style="color:var(--ink-low)">Data not loaded.</p>';return}
  const tally=(arr,key)=>{const o={};arr.forEach(l=>{if(l[key])o[l[key]]=(o[l[key]]||0)+1});return Object.entries(o).sort((a,b)=>b[1]-a[1])};
  const famE=tally(langs,'family'); const maxF=famE[0]?famE[0][1]:1;
  const woE=tally(langs,'wordOrder'); const maxW=woE[0]?woE[0][1]:1;
  const morphE=tally(langs,'morphType'); const maxM=morphE[0]?morphE[0][1]:1;
  const endC={}; langs.forEach(l=>{const s=l.unescoStatus||'unknown';endC[s]=(endC[s]||0)+1});
  const endColors={safe:'var(--safe)',vulnerable:'var(--vuln)',definitely_endangered:'var(--endanger)',severely_endangered:'var(--severe)',critically_endangered:'var(--critical)',extinct:'var(--extinct)'};
  c.innerHTML=`<div class="stats-grid">
    <div class="stats-card"><div class="stats-card-title">Languages by Family</div>${famE.slice(0,12).map(([f,n])=>`<div class="stats-row-item"><div class="stats-bar-top"><span>${getFamilyName(f)}</span><span>${n}</span></div><div class="bar-wrap"><div class="bar-fill" style="width:${(n/maxF)*100}%;background:${getFamilyHex(f)}"></div></div></div>`).join('')}</div>
    <div class="stats-card"><div class="stats-card-title">Word Order Distribution</div>${woE.map(([w,n])=>`<div class="stats-row-item"><div class="stats-bar-top"><span>${w}</span><span>${n}</span></div><div class="bar-wrap"><div class="bar-fill" style="width:${(n/maxW)*100}%;background:var(--cyan)"></div></div></div>`).join('')}</div>
    <div class="stats-card"><div class="stats-card-title">Endangerment Status</div>${Object.entries(endC).map(([s,n])=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px"><span style="color:${endColors[s]||'var(--ink-mid)'}">${s.replace(/_/g,' ')}</span><span style="font-weight:600;color:var(--ink)">${n}</span></div>`).join('')}</div>
    <div class="stats-card"><div class="stats-card-title">Morphological Type</div>${morphE.map(([m,n])=>`<div class="stats-row-item"><div class="stats-bar-top"><span>${m}</span><span>${n}</span></div><div class="bar-wrap"><div class="bar-fill" style="width:${(n/maxM)*100}%;background:var(--violet)"></div></div></div>`).join('')}</div>
  </div>`;
}
</script>
</body>
</html>
