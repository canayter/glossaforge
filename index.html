<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob: https://*.tile.openstreetmap.org https://*.basemaps.cartocdn.com; connect-src 'self'; frame-src 'none'; frame-ancestors 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta name="description" content="GlossaForge ‚Äî Interactive world language map. Explore 500+ languages by family, typology, and endangerment.">
<meta name="theme-color" content="#00d4ff">
<title>GlossaForge ‚Äî World Language Map</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw==" crossorigin="anonymous" referrerpolicy="no-referrer">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
/* ‚ïê‚ïê‚ïê DESIGN SYSTEM ‚ïê‚ïê‚ïê */
:root {
  --void:#06060e; --base:#0d0d18; --raised:#12121f; --surface:#181828;
  --lift:#1e1e30; --hover:#252538; --active:#2c2c42;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.14);
  --cyan:#00d4ff; --cyan-dim:rgba(0,212,255,0.10); --cyan-glow:rgba(0,212,255,0.28);
  --violet:#8b5cf6;
  --ink:#eeeef5; --ink-mid:#9898b0; --ink-low:#5a5a72; --ink-dim:#2e2e44;
  --safe:#34d399; --vuln:#fbbf24; --endanger:#fb923c;
  --severe:#f87171; --critical:#ef4444; --extinct:#52525b;
  --font-h:'Space Grotesk',system-ui,sans-serif;
  --font-b:'Inter',system-ui,sans-serif;
  --font-m:'JetBrains Mono',monospace;
  --r:8px; --r-lg:14px; --r-xl:20px; --r-full:9999px;
  --ease:cubic-bezier(0.16,1,0.3,1);
  --hdr:52px;
}
[data-theme="light"] {
  --void:#f0f0f5; --base:#e8e8f0; --raised:#ffffff; --surface:#ffffff;
  --lift:#ffffff; --hover:#dddde8; --active:#d0d0df;
  --border:rgba(0,0,0,0.08); --border2:rgba(0,0,0,0.15);
  --ink:#111120; --ink-mid:#4a4a60; --ink-low:#7070a0; --ink-dim:#d0d0e0;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font-b);font-size:14px;color:var(--ink);background:var(--void);-webkit-font-smoothing:antialiased}
button,input,select{font:inherit;color:inherit}
a{color:var(--cyan);text-decoration:none}
::selection{background:var(--cyan);color:#000}
:focus-visible{outline:2px solid var(--cyan);outline-offset:2px;border-radius:4px}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.site-hdr {
  position:fixed;top:0;left:0;right:0;height:var(--hdr);z-index:1000;
  display:flex;align-items:center;gap:10px;padding:0 14px;
  background:rgba(6,6,14,0.88);backdrop-filter:blur(18px);
  border-bottom:1px solid var(--border);
}
[data-theme="light"] .site-hdr{background:rgba(240,240,245,0.90)}
.logo{
  display:flex;align-items:center;gap:8px;
  font-family:var(--font-h);font-size:1.05rem;font-weight:700;
  letter-spacing:-0.02em;color:var(--ink);white-space:nowrap;cursor:pointer;
}
.logo em{font-style:normal;color:var(--cyan)}
.hdr-search{
  flex:1;max-width:260px;
  display:flex;align-items:center;gap:6px;
  background:var(--raised);border:1px solid var(--border2);
  border-radius:var(--r-full);padding:0 12px;height:34px;
}
.hdr-search input{background:none;border:none;outline:none;font-size:13px;color:var(--ink);flex:1;min-width:0}
.hdr-search input::placeholder{color:var(--ink-low)}
.hdr-search svg{flex-shrink:0;opacity:.5}
.hdr-sel{
  background:var(--raised);border:1px solid var(--border);
  border-radius:var(--r-full);padding:4px 10px;
  font-size:12px;color:var(--ink-mid);cursor:pointer;outline:none;
  white-space:nowrap;
}
.hdr-sel:focus{border-color:var(--cyan)}
.hdr-end{display:flex;align-items:center;gap:6px;margin-left:auto}
.icon-btn{
  width:34px;height:34px;border-radius:var(--r);
  background:var(--raised);border:1px solid var(--border);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:15px;transition:background 120ms;flex-shrink:0;
}
.icon-btn:hover{background:var(--hover)}
.hdr-count{
  font-size:11px;color:var(--ink-low);white-space:nowrap;
  padding:4px 10px;background:var(--raised);border:1px solid var(--border);
  border-radius:var(--r-full);
}

/* ‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê */
#mapContainer{
  position:fixed;top:var(--hdr);left:0;right:0;bottom:0;z-index:1;
  background:#07090c;
}
/* Leaflet tile layer loads into here */
.leaflet-container{background:#07090c}
[data-theme="light"] .leaflet-container{background:#c8d8e8}

/* ‚ïê‚ïê‚ïê MAP OVERLAY CONTROLS ‚ïê‚ïê‚ïê */
.map-filters{
  position:fixed;top:calc(var(--hdr) + 10px);left:12px;z-index:500;
  display:flex;flex-wrap:wrap;gap:6px;max-width:calc(100vw - 180px);
}
.mf-chip{
  display:flex;align-items:center;gap:5px;
  background:rgba(13,13,24,0.88);backdrop-filter:blur(12px);
  border:1px solid var(--border2);border-radius:var(--r-full);
  padding:4px 10px;font-size:11px;color:var(--ink-mid);
}
[data-theme="light"] .mf-chip{background:rgba(255,255,255,0.90)}
.mf-chip select{
  background:none;border:none;outline:none;
  font:inherit;color:inherit;cursor:pointer;font-size:11px;
}
.mf-reset{
  background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);
  border-radius:var(--r-full);padding:4px 10px;
  font-size:11px;color:#f87171;cursor:pointer;
  display:none;white-space:nowrap;
}
.mf-reset:hover{background:rgba(239,68,68,0.20)}
.mf-extinct{
  display:flex;align-items:center;gap:5px;
  background:rgba(13,13,24,0.88);backdrop-filter:blur(12px);
  border:1px solid var(--border2);border-radius:var(--r-full);
  padding:4px 10px;font-size:11px;color:var(--ink-low);cursor:pointer;
}
[data-theme="light"] .mf-extinct{background:rgba(255,255,255,0.90)}

.map-layers{
  position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:500;
  display:flex;gap:3px;
  background:rgba(13,13,24,0.90);backdrop-filter:blur(12px);
  border:1px solid var(--border2);border-radius:var(--r-full);padding:4px;
  white-space:nowrap;
}
[data-theme="light"] .map-layers{background:rgba(255,255,255,0.90)}
.ml-btn{
  padding:5px 14px;border-radius:var(--r-full);
  font-size:12px;font-weight:500;color:var(--ink-low);
  cursor:pointer;border:none;background:none;transition:all 100ms;
}
.ml-btn:hover{color:var(--ink)}
.ml-btn.active{background:var(--cyan);color:#000;font-weight:600}
[data-theme="light"] .ml-btn.active{color:#fff}

.map-legend{
  position:fixed;bottom:70px;right:12px;z-index:500;
  background:rgba(13,13,24,0.90);backdrop-filter:blur(12px);
  border:1px solid var(--border2);border-radius:var(--r-lg);
  padding:10px 12px;min-width:130px;max-height:260px;overflow-y:auto;
  font-size:11px;
}
[data-theme="light"] .map-legend{background:rgba(255,255,255,0.90)}
.leg-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--ink-low);margin-bottom:7px}
.leg-row{display:flex;align-items:center;gap:6px;color:var(--ink-mid);margin-bottom:4px}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* Leaflet popup */
.leaflet-popup-content-wrapper{background:var(--raised)!important;border:1px solid var(--border2)!important;border-radius:var(--r-lg)!important;box-shadow:0 8px 24px rgba(0,0,0,.6)!important;color:var(--ink)!important}
.leaflet-popup-tip{background:var(--raised)!important}
.leaflet-popup-content{margin:14px!important;font-family:var(--font-b)!important;font-size:13px!important}
.pp-name{font-family:var(--font-h);font-size:.95rem;font-weight:700;margin-bottom:2px}
.pp-fam{font-size:11px;font-weight:600;margin-bottom:8px}
.pp-row{display:flex;justify-content:space-between;gap:12px;padding:3px 0;border-top:1px solid var(--border)}
.pp-row span:first-child{color:var(--ink-low);font-size:11px}
.pp-row span:last-child{font-size:11px;font-weight:500}
.pp-btn{
  display:block;margin-top:10px;padding:6px 12px;text-align:center;
  background:var(--cyan-dim);border:1px solid var(--cyan);border-radius:var(--r);
  font-size:11px;font-weight:600;color:var(--cyan);cursor:pointer;
}
.pp-btn:hover{background:rgba(0,212,255,.2)}

/* ‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê */
.detail-panel{
  position:fixed;top:var(--hdr);right:0;width:380px;bottom:0;z-index:700;
  background:var(--base);border-left:1px solid var(--border2);
  overflow-y:auto;
  transform:translateX(100%);transition:transform .28s var(--ease);
}
.detail-panel.open{transform:translateX(0)}
.dp-head{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;background:var(--base);border-bottom:1px solid var(--border);
}
.dp-close{
  width:28px;height:28px;border-radius:var(--r);
  background:var(--raised);border:1px solid var(--border);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;
}
.dp-close:hover{background:var(--hover)}
.dp-body{padding:16px}
.dp-name{font-family:var(--font-h);font-size:1.4rem;font-weight:700;letter-spacing:-.02em;color:var(--ink);margin-bottom:2px}
.dp-native{font-size:13px;color:var(--ink-low);margin-bottom:3px}
.dp-alts{font-size:11px;color:var(--ink-dim);margin-bottom:12px}
.dp-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:18px}
.fam-tag{padding:3px 10px;border-radius:var(--r-full);font-size:11px;font-weight:600}
.badge{padding:3px 10px;border-radius:var(--r-full);font-size:11px;font-weight:600}
.badge-safe{background:rgba(52,211,153,.12);color:var(--safe)}
.badge-vulnerable{background:rgba(251,191,36,.12);color:var(--vuln)}
.badge-endangered{background:rgba(251,146,60,.12);color:var(--endanger)}
.badge-severely{background:rgba(248,113,113,.12);color:var(--severe)}
.badge-critical{background:rgba(239,68,68,.12);color:var(--critical)}
.badge-extinct{background:rgba(82,82,91,.12);color:var(--extinct)}
.dp-sec{margin-bottom:18px}
.dp-sec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-low);margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.dp-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.dp-field{background:var(--raised);border:1px solid var(--border);border-radius:var(--r);padding:8px 10px}
.dp-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink-low);margin-bottom:2px}
.dp-val{font-size:12px;font-weight:500;color:var(--ink)}
.dp-field-wide{grid-column:1/-1}
.dp-cite{font-size:10px;color:var(--ink-dim);margin-top:3px;font-style:italic}

/* ‚ïê‚ïê‚ïê MENU DRAWER ‚ïê‚ïê‚ïê */
.menu-drawer{
  position:fixed;inset:0;z-index:800;
  background:var(--base);
  display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .3s var(--ease);
}
.menu-drawer.open{transform:translateY(0)}
.md-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;height:var(--hdr);border-bottom:1px solid var(--border);
  flex-shrink:0;background:var(--base);
}
.md-logo{font-family:var(--font-h);font-size:1rem;font-weight:700;color:var(--ink)}
.md-logo em{font-style:normal;color:var(--cyan)}
.md-tabs{
  display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;
  overflow-x:auto;
}
.md-tab{
  padding:12px 20px;font-family:var(--font-h);font-size:13px;font-weight:500;
  color:var(--ink-low);cursor:pointer;border:none;background:none;
  border-bottom:2px solid transparent;margin-bottom:-1px;
  white-space:nowrap;transition:all 120ms;
}
.md-tab:hover{color:var(--ink)}
.md-tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.md-body{flex:1;overflow-y:auto;padding:20px 24px}

/* ‚ïê‚ïê‚ïê SHARED COMPONENTS ‚ïê‚ïê‚ïê */
.sec-h2{font-family:var(--font-h);font-size:1.4rem;font-weight:700;letter-spacing:-.025em;color:var(--ink);margin-bottom:4px}
.sec-sub{font-size:13px;color:var(--ink-mid);margin-bottom:20px;max-width:560px}
.inp{
  width:100%;padding:8px 12px;background:var(--raised);
  border:1px solid var(--border);border-radius:var(--r);
  font-size:13px;color:var(--ink);outline:none;transition:border-color 120ms;
}
.inp:focus{border-color:var(--cyan)}
.inp::placeholder{color:var(--ink-low)}
.sel{
  padding:8px 12px;background:var(--raised);
  border:1px solid var(--border);border-radius:var(--r);
  font-size:13px;color:var(--ink);cursor:pointer;outline:none;
}
.sel:focus{border-color:var(--cyan)}
.fl-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--ink-low);margin-bottom:5px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 16px;border-radius:var(--r);font-family:var(--font-h);font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all 120ms}
.btn-primary{background:var(--cyan);color:#000;border-color:var(--cyan)}
.btn-primary:hover{opacity:.88}
.btn-ghost{background:var(--raised);color:var(--ink);border-color:var(--border)}
.btn-ghost:hover{background:var(--hover)}
.btn-sm{padding:5px 12px;font-size:12px}

/* ‚ïê‚ïê‚ïê EXPLORER ‚ïê‚ïê‚ïê */
.expl-top{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;align-items:flex-end}
.expl-search-wrap{flex:1;min-width:180px}
.res-meta{font-size:12px;color:var(--ink-low);margin-bottom:10px}
.lang-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.lang-card{
  background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:14px;cursor:pointer;transition:all 120ms;
}
.lang-card:hover{border-color:var(--border2);background:var(--surface);transform:translateY(-1px)}
.lc-name{font-family:var(--font-h);font-size:.9rem;font-weight:600;color:var(--ink);margin-bottom:1px}
.lc-native{font-size:11px;color:var(--ink-low);margin-bottom:6px}
.lc-badges{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px}
.lc-foot{display:flex;justify-content:space-between;font-size:11px;color:var(--ink-low)}
.lc-iso{font-family:var(--font-m);font-size:11px;color:var(--ink-low)}

/* ‚ïê‚ïê‚ïê FAMILIES TREE ‚ïê‚ïê‚ïê */
.tree-fam{background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);margin-bottom:7px;overflow:hidden}
.tree-fam-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;transition:background 120ms;user-select:none}
.tree-fam-hd:hover{background:var(--hover)}
.tree-fam-left{display:flex;align-items:center;gap:8px;font-family:var(--font-h);font-size:.9rem;font-weight:600;color:var(--ink)}
.tree-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.tree-chev{font-size:9px;color:var(--ink-low);transition:transform 160ms}
.tree-chev.open{transform:rotate(90deg)}
.tree-stats{font-size:11px;color:var(--ink-low);display:flex;gap:12px}
.tree-body{display:none;border-top:1px solid var(--border)}
.tree-body.open{display:block}
.tree-branch{padding:5px 14px 5px 28px;border-bottom:1px solid var(--border)}
.tree-branch:last-child{border-bottom:none}
.tree-br-hd{display:flex;align-items:center;gap:6px;padding:5px 0;cursor:pointer;font-size:12px;font-weight:600;color:var(--ink-mid);user-select:none}
.tree-br-hd:hover{color:var(--ink)}
.tree-sub{display:none;padding-left:12px}
.tree-sub.open{display:block}
.tree-lang{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;border-radius:5px;font-size:12px;color:var(--ink-mid);cursor:pointer}
.tree-lang:hover{background:var(--hover);color:var(--ink)}
.tree-lang-iso{font-family:var(--font-m);font-size:10px;color:var(--ink-dim)}

/* ‚ïê‚ïê‚ïê TOOLS ‚ïê‚ïê‚ïê */
.tool-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px;overflow-x:auto}
.tool-tab{padding:9px 18px;font-family:var(--font-h);font-size:13px;font-weight:500;color:var(--ink-low);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;margin-bottom:-1px;white-space:nowrap;transition:all 120ms}
.tool-tab:hover{color:var(--ink)}
.tool-tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.tool-panel{display:none}
.tool-panel.active{display:block}
.tool-h{font-family:var(--font-h);font-size:1rem;font-weight:600;margin-bottom:5px;color:var(--ink)}
.tool-sub{font-size:13px;color:var(--ink-mid);margin-bottom:18px;max-width:540px;line-height:1.6}
.bar-wrap{background:var(--raised);border-radius:var(--r-full);height:5px;overflow:hidden;flex:1}
.bar-fill{height:100%;border-radius:var(--r-full);transition:width .4s var(--ease)}
.res-card{background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);padding:12px 14px;margin-bottom:7px}
.res-card:hover{border-color:var(--border2)}
.tbl-wrap{overflow-x:auto;border-radius:var(--r-lg);border:1px solid var(--border)}
.comp-table{width:100%;border-collapse:collapse;font-size:12px}
.comp-table th{background:var(--surface);padding:9px 12px;text-align:left;font-family:var(--font-h);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--ink-low);border-bottom:1px solid var(--border)}
.comp-table td{padding:8px 12px;border-bottom:1px solid var(--border);color:var(--ink-mid)}
.comp-table td:first-child{color:var(--ink-low);font-size:11px}
.comp-table tr.match td{color:var(--ink);background:rgba(0,212,255,.04)}
.comp-table tr:last-child td{border-bottom:none}
.tl-wrap{position:relative;padding-left:22px}
.tl-wrap::before{content:'';position:absolute;left:5px;top:0;bottom:0;width:1px;background:var(--border)}
.tl-item{position:relative;padding:6px 0 6px 18px;margin-bottom:1px}
.tl-dot{position:absolute;left:-17px;top:12px;width:8px;height:8px;border-radius:50%}
.tl-period{font-family:var(--font-m);font-size:10px;color:var(--ink-low);margin-bottom:1px}
.tl-name{font-size:12px;font-weight:600;color:var(--ink);margin-bottom:1px}
.tl-meta{font-size:10px;color:var(--ink-low)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px}
.stats-card{background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px}
.stats-ct{font-family:var(--font-h);font-size:13px;font-weight:600;color:var(--ink);margin-bottom:12px}
.s-row{margin-bottom:8px}
.s-bar-top{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;color:var(--ink-mid)}

/* ‚ïê‚ïê‚ïê SOURCES ‚ïê‚ïê‚ïê */
.src-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:24px}
.src-card{background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px}
.src-name{font-family:var(--font-h);font-size:.9rem;font-weight:600;margin-bottom:5px;color:var(--ink)}
.src-desc{font-size:12px;color:var(--ink-mid);line-height:1.55;margin-bottom:7px}
.src-url{font-family:var(--font-m);font-size:11px;color:var(--cyan)}
.src-ref{font-size:11px;color:var(--ink-low);font-style:italic;margin-bottom:3px}
.know-sec{margin-bottom:28px}
.know-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-low);margin-bottom:12px;padding-bottom:7px;border-bottom:1px solid var(--border)}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:768px){
  .hdr-sel{display:none}
  .hdr-search{max-width:none;flex:1}
  .map-filters{max-width:calc(100vw - 60px)}
  .mf-chip select{max-width:90px}
  .detail-panel{width:100%;right:0;border-left:none;border-top:1px solid var(--border2)}
  .map-layers{bottom:70px;font-size:11px}
  .map-legend{display:none}
  .md-body{padding:16px}
  .expl-top{flex-direction:column}
}
@media(max-width:480px){
  .site-hdr{padding:0 10px;gap:6px}
  .logo{font-size:.95rem}
  .map-filters{top:calc(var(--hdr)+8px);left:8px;gap:4px}
  .mf-chip{padding:3px 8px}
}
</style>
</head>
<body>
<a class="sr-only" href="#mapContainer">Skip to map</a>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header class="site-hdr">
  <div class="logo" onclick="closeAll()" title="GlossaForge ‚Äî back to map">
    Glossa<em>Forge</em>
  </div>
  <div class="hdr-search">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="mapSearch" placeholder="Search language or ISO code‚Ä¶" autocomplete="off" maxlength="100">
  </div>
  <select class="hdr-sel" id="hdFamily" aria-label="Filter by family">
    <option value="">All Families</option>
  </select>
  <select class="hdr-sel" id="hdRegion" aria-label="Filter by region">
    <option value="">All Regions</option>
  </select>
  <select class="hdr-sel" id="hdStatus" aria-label="Filter by status">
    <option value="">Any Status</option>
    <option value="safe">Safe</option>
    <option value="vulnerable">Vulnerable</option>
    <option value="definitely_endangered">Endangered</option>
    <option value="severely_endangered">Severely Endangered</option>
    <option value="critically_endangered">Critically Endangered</option>
    <option value="extinct">Extinct</option>
  </select>
  <div class="hdr-end">
    <span class="hdr-count" id="hdrCount">‚Äî</span>
    <button class="icon-btn" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">üåô</button>
    <button class="icon-btn" id="menuBtn" aria-label="Open menu" title="Explorer, Families, Tools, Sources">‚ò∞</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê MAP (always rendered) ‚ïê‚ïê‚ïê -->
<div id="mapContainer" role="application" aria-label="World language map"></div>

<!-- ‚ïê‚ïê‚ïê FLOATING MAP FILTER ROW (extra filters) ‚ïê‚ïê‚ïê -->
<div class="map-filters" id="mapFilters">
  <div class="mf-chip">
    <span>Order:</span>
    <select id="fWordOrder" aria-label="Filter by word order">
      <option value="">Any</option>
      <option value="SOV">SOV</option>
      <option value="SVO">SVO</option>
      <option value="VSO">VSO</option>
      <option value="VOS">VOS</option>
      <option value="OVS">OVS</option>
      <option value="OSV">OSV</option>
    </select>
  </div>
  <div class="mf-chip">
    <span>Morph:</span>
    <select id="fMorph" aria-label="Filter by morphological type">
      <option value="">Any</option>
      <option value="isolating">Isolating</option>
      <option value="agglutinative">Agglutinative</option>
      <option value="fusional">Fusional</option>
      <option value="polysynthetic">Polysynthetic</option>
    </select>
  </div>
  <div class="mf-chip">
    <span>Tone:</span>
    <select id="fTone" aria-label="Filter by tone system">
      <option value="">Any</option>
      <option value="none">No tone</option>
      <option value="simple">Simple</option>
      <option value="complex">Complex</option>
    </select>
  </div>
  <label class="mf-extinct" title="Show extinct languages on map">
    <input type="checkbox" id="fExtinct" style="accent-color:var(--cyan)">
    Extinct
  </label>
  <button class="mf-reset" id="resetBtn" onclick="resetFilters()">‚úï Reset</button>
</div>

<!-- ‚ïê‚ïê‚ïê MAP LAYER SWITCHER ‚ïê‚ïê‚ïê -->
<nav class="map-layers" aria-label="Map colour mode">
  <button class="ml-btn active" data-layer="family">Family</button>
  <button class="ml-btn" data-layer="endangerment">Status</button>
  <button class="ml-btn" data-layer="wordorder">Word Order</button>
  <button class="ml-btn" data-layer="morphology">Morphology</button>
  <button class="ml-btn" data-layer="tone">Tone</button>
</nav>

<!-- ‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê -->
<div id="mapLegend" class="map-legend" aria-label="Map legend"></div>

<!-- ‚ïê‚ïê‚ïê LANGUAGE DETAIL PANEL ‚ïê‚ïê‚ïê -->
<aside id="detailPanel" class="detail-panel" aria-label="Language detail">
  <div class="dp-head">
    <span id="dpTitle" style="font-family:var(--font-h);font-size:.9rem;font-weight:600;color:var(--ink-mid)">Language detail</span>
    <button class="dp-close" onclick="closeDetail()" aria-label="Close detail panel">‚úï</button>
  </div>
  <div class="dp-body" id="dpBody"></div>
</aside>

<!-- ‚ïê‚ïê‚ïê MENU DRAWER ‚ïê‚ïê‚ïê -->
<div id="menuDrawer" class="menu-drawer" role="dialog" aria-label="GlossaForge menu">
  <div class="md-head">
    <span class="md-logo">Glossa<em>Forge</em></span>
    <button class="icon-btn" onclick="closeMenu()" aria-label="Close menu">‚úï</button>
  </div>
  <nav class="md-tabs" role="tablist">
    <button class="md-tab active" data-drawer="explorer" role="tab">Explorer</button>
    <button class="md-tab" data-drawer="families" role="tab">Families</button>
    <button class="md-tab" data-drawer="tools" role="tab">Tools</button>
    <button class="md-tab" data-drawer="sources" role="tab">Sources</button>
  </nav>
  <div class="md-body">

    <!-- EXPLORER -->
    <div id="drawer-explorer" class="md-view">
      <div class="sec-h2">Language Explorer</div>
      <p class="sec-sub">Search and filter 500+ world languages. Click any card for a full typological profile.</p>
      <div class="expl-top">
        <div class="expl-search-wrap">
          <div class="fl-lbl">Search</div>
          <input class="inp" type="text" id="exSearch" placeholder="Name, ISO code, or alternate name‚Ä¶" maxlength="100">
        </div>
        <div>
          <div class="fl-lbl">Family</div>
          <select class="sel" id="exFamily"><option value="">All</option></select>
        </div>
        <div>
          <div class="fl-lbl">Region</div>
          <select class="sel" id="exRegion"><option value="">All</option></select>
        </div>
        <div>
          <div class="fl-lbl">Status</div>
          <select class="sel" id="exStatus">
            <option value="">Any</option>
            <option value="safe">Safe</option>
            <option value="vulnerable">Vulnerable</option>
            <option value="definitely_endangered">Endangered</option>
            <option value="severely_endangered">Severely Endangered</option>
            <option value="critically_endangered">Critically Endangered</option>
            <option value="extinct">Extinct</option>
          </select>
        </div>
      </div>
      <div class="res-meta" id="exCount"></div>
      <div class="lang-grid" id="exResults"></div>
    </div>

    <!-- FAMILIES -->
    <div id="drawer-families" class="md-view" style="display:none">
      <div class="sec-h2">Language Families</div>
      <p class="sec-sub">Hierarchical view of all language families, branches, and individual languages.</p>
      <div style="max-width:360px;margin-bottom:16px">
        <input class="inp" type="text" id="famSearch" placeholder="Search family or language name‚Ä¶" maxlength="100">
      </div>
      <div id="famTree"></div>
    </div>

    <!-- TOOLS -->
    <div id="drawer-tools" class="md-view" style="display:none">
      <div class="sec-h2">Linguistics Tools</div>
      <p class="sec-sub">Intelligibility matching, grammar similarity, side-by-side comparison, timeline, and world statistics.</p>
      <div class="tool-tabs" role="tablist">
        <button class="tool-tab active" data-tool="intelligibility">Intelligibility</button>
        <button class="tool-tab" data-tool="similarity">Grammar Similarity</button>
        <button class="tool-tab" data-tool="comparison">Comparison</button>
        <button class="tool-tab" data-tool="timeline">Timeline</button>
        <button class="tool-tab" data-tool="wstats">World Stats</button>
      </div>
      <div id="tool-intelligibility" class="tool-panel active" role="tabpanel">
        <div class="tool-h">Mutual Intelligibility Matcher</div>
        <p class="tool-sub">Select a language to see which others its speakers can understand ‚Äî and to what degree. Based on Gooskens (2007), Tang &amp; van Heuven (2009).</p>
        <div style="max-width:380px;margin-bottom:18px">
          <div class="fl-lbl">Select Language</div>
          <select class="sel" id="intLang" style="width:100%"><option value="">Choose a language‚Ä¶</option></select>
        </div>
        <div id="intResults"></div>
      </div>
      <div id="tool-similarity" class="tool-panel" role="tabpanel">
        <div class="tool-h">Grammatical Similarity Finder</div>
        <p class="tool-sub">Find languages that share grammatical features across families. Scored via WALS-derived typological features.</p>
        <div style="max-width:380px;margin-bottom:18px">
          <div class="fl-lbl">Select Language</div>
          <select class="sel" id="simLang" style="width:100%"><option value="">Choose a language‚Ä¶</option></select>
        </div>
        <div id="simResults"></div>
      </div>
      <div id="tool-comparison" class="tool-panel" role="tabpanel">
        <div class="tool-h">Language Comparison</div>
        <p class="tool-sub">Select 2‚Äì5 languages for a side-by-side typological comparison. Matching features are highlighted.</p>
        <div id="compSelectors" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px"></div>
        <button class="btn btn-ghost btn-sm" onclick="addCompSlot()" id="addCompBtn">+ Add Language</button>
        <div id="compResults" style="margin-top:18px"></div>
      </div>
      <div id="tool-timeline" class="tool-panel" role="tabpanel">
        <div class="tool-h">Historical Timeline</div>
        <p class="tool-sub">Extinct and historical languages with their approximate dates of last attestation.</p>
        <div style="max-width:280px;margin-bottom:18px">
          <div class="fl-lbl">Filter by Family</div>
          <select class="sel" id="tlFamily" style="width:100%"><option value="">All Families</option></select>
        </div>
        <div id="tlResults"></div>
      </div>
      <div id="tool-wstats" class="tool-panel" role="tabpanel">
        <div class="tool-h">World Language Statistics</div>
        <p class="tool-sub">Global overview of language diversity, distribution, and endangerment.</p>
        <div id="wstatsResults"></div>
      </div>
    </div>

    <!-- SOURCES -->
    <div id="drawer-sources" class="md-view" style="display:none">
      <div class="sec-h2">Sources &amp; Methodology</div>
      <p class="sec-sub">Data provenance, scoring methodology, and academic references. All typological data derives from peer-reviewed databases and published literature.</p>
      <div class="know-sec">
        <div class="know-title">Primary Databases</div>
        <div class="src-grid">
          <div class="src-card">
            <div class="src-name">Glottolog 5.0</div>
            <p class="src-desc">Comprehensive catalogue of all known language families, languages, and dialects. Source for ISO 639-3 codes, family classification, and geographic coordinates.</p>
            <div class="src-url">glottolog.org</div>
            <div class="src-ref">Hammarstr√∂m, H., Forkel, R., Haspelmath, M. &amp; Bank, S. (2024). <em>Glottolog 5.0.</em> Leipzig: MPI-EVA.</div>
          </div>
          <div class="src-card">
            <div class="src-name">WALS ‚Äî World Atlas of Language Structures</div>
            <p class="src-desc">Cross-linguistic database of structural (typological) properties. Primary source for word order, morphological type, case alignment, gender, and evidentiality data.</p>
            <div class="src-url">wals.info</div>
            <div class="src-ref">Dryer, M. S. &amp; Haspelmath, M. (eds.) (2013). <em>WALS Online.</em> Leipzig: MPI-EVA.</div>
          </div>
          <div class="src-card">
            <div class="src-name">PHOIBLE 2.0</div>
            <p class="src-desc">Repository of cross-linguistic phonological inventory data. Source for consonant/vowel inventory sizes, click phonemes, ejectives, tonal classifications, and nasal vowels.</p>
            <div class="src-url">phoible.org</div>
            <div class="src-ref">Moran, S. &amp; McCloy, D. (eds.) (2019). <em>PHOIBLE 2.0.</em> Jena: MPI-SHH.</div>
          </div>
          <div class="src-card">
            <div class="src-name">UNESCO Atlas of the World's Languages in Danger</div>
            <p class="src-desc">Classification of languages by endangerment: safe, vulnerable, definitely endangered, severely endangered, critically endangered, and dormant/extinct. Used for all unescoStatus values.</p>
            <div class="src-url">unesco.org/languages-atlas</div>
            <div class="src-ref">Moseley, C. (ed.) (2010). <em>Atlas of the World's Languages in Danger</em>, 3rd ed. Paris: UNESCO.</div>
          </div>
          <div class="src-card">
            <div class="src-name">Ethnologue, 27th Edition</div>
            <p class="src-desc">Reference catalogue of all known living languages. Source for speaker population estimates, country-level distribution, and EGIDS vitality levels.</p>
            <div class="src-url">ethnologue.com</div>
            <div class="src-ref">Eberhard, D. M., Simons, G. F. &amp; Fennig, C. D. (eds.) (2024). <em>Ethnologue</em>, 27th ed. Dallas: SIL International.</div>
          </div>
          <div class="src-card">
            <div class="src-name">UniMorph / SIGMORPHON</div>
            <p class="src-desc">Cross-linguistic morphological database. Secondary source for morphological type and case system complexity.</p>
            <div class="src-url">unimorph.github.io</div>
            <div class="src-ref">Batsuren, K. et al. (2022). UniMorph 4.0. <em>LREC 2022 Proceedings</em>.</div>
          </div>
        </div>
      </div>
      <div class="know-sec">
        <div class="know-title">Mutual Intelligibility Sources</div>
        <div style="background:var(--raised);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;font-size:13px;color:var(--ink-mid);line-height:1.7">
          <p style="margin-bottom:10px">Intelligibility scores represent the percentage of content a native speaker can understand without prior study of the target language. Scores are <strong style="color:var(--ink)">directional</strong> ‚Äî Portuguese ‚Üí Spanish intelligibility differs from Spanish ‚Üí Portuguese.</p>
          <p style="margin-bottom:8px"><strong style="color:var(--ink)">Key literature:</strong></p>
          <ul style="padding-left:18px;list-style:disc">
            <li>Gooskens, C. (2007). The contribution of linguistic factors to the intelligibility of closely related languages. <em>Journal of Multilingual and Multicultural Development</em>, 28(6), 445‚Äì467.</li>
            <li style="margin-top:6px">Tang, C. &amp; van Heuven, V. J. (2009). Mutual intelligibility of Chinese dialects experimentally tested. <em>Lingua</em>, 119(5), 709‚Äì732.</li>
            <li style="margin-top:6px">Golubovic, J. &amp; Gooskens, C. (2020). Mutual intelligibility between West South Slavic languages. <em>Russian Linguistics</em>, 39(3), 351‚Äì373.</li>
          </ul>
        </div>
      </div>
      <div class="know-sec">
        <div class="know-title">Grammatical Similarity Score ‚Äî Weight Table</div>
        <div class="tbl-wrap">
          <table class="comp-table">
            <thead><tr><th>Feature</th><th>Weight</th><th>Source</th></tr></thead>
            <tbody>
              <tr><td>Word Order (SOV/SVO/VSO‚Ä¶)</td><td>15%</td><td>WALS ch. 81A</td></tr>
              <tr><td>Morphological Type</td><td>15%</td><td>WALS ch. 26A</td></tr>
              <tr><td>Case Alignment</td><td>12%</td><td>WALS ch. 98A</td></tr>
              <tr><td>Case Count</td><td>8%</td><td>WALS ch. 49A</td></tr>
              <tr><td>Tone System</td><td>10%</td><td>PHOIBLE / WALS ch. 13A</td></tr>
              <tr><td>Gender/Noun Class System</td><td>8%</td><td>WALS ch. 30A</td></tr>
              <tr><td>Evidentiality</td><td>7%</td><td>WALS ch. 77A</td></tr>
              <tr><td>Vowel Harmony</td><td>5%</td><td>WALS ch. 116A</td></tr>
              <tr><td>Consonant Inventory Size</td><td>5%</td><td>PHOIBLE / WALS ch. 1A</td></tr>
              <tr><td>Vowel Inventory Size</td><td>5%</td><td>PHOIBLE / WALS ch. 2A</td></tr>
              <tr><td>Definiteness Strategy</td><td>5%</td><td>WALS ch. 37A</td></tr>
              <tr><td>Negation Strategy</td><td>5%</td><td>WALS ch. 143A</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="know-sec">
        <div class="know-title">Glossary</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px">
          <div class="src-card"><div class="src-name">UNESCO Status</div><p class="src-desc"><strong>Safe</strong>: spoken in all domains, intergenerational transmission secure. <strong>Vulnerable</strong>: mostly spoken by adults. <strong>Definitely endangered</strong>: children no longer learn as native. <strong>Severely endangered</strong>: very few speakers, often elderly. <strong>Critically endangered</strong>: near extinction. <strong>Extinct</strong>: no native speakers remain.</p></div>
          <div class="src-card"><div class="src-name">Word Order</div><p class="src-desc">Canonical order of Subject (S), Verb (V), and Object (O) in declarative clauses. SOV (e.g. Japanese), SVO (English), VSO (Welsh), VOS (Malagasy), OVS (Hixkaryana), OSV (rare). Source: WALS 81A.</p></div>
          <div class="src-card"><div class="src-name">Morphological Type</div><p class="src-desc"><strong>Isolating</strong>: words are typically single morphemes (Mandarin). <strong>Agglutinative</strong>: morphemes stack with clear boundaries (Turkish). <strong>Fusional</strong>: morphemes blend together (Russian). <strong>Polysynthetic</strong>: entire sentences encoded in one word (Inuktitut).</p></div>
          <div class="src-card"><div class="src-name">ISO 639-3</div><p class="src-desc">Three-letter code identifying individual human languages, maintained by SIL International. GlossaForge uses ISO 639-3 as primary language identifiers (e.g., eng = English, cmn = Mandarin Chinese).</p></div>
          <div class="src-card"><div class="src-name">Glottocode</div><p class="src-desc">Unique identifier from the Glottolog catalogue. Unlike ISO 639-3, glottocodes also cover dialects, proto-languages, and language families at any node in the tree.</p></div>
          <div class="src-card"><div class="src-name">Evidentiality</div><p class="src-desc">Grammaticalized encoding of the source of information: whether the speaker witnessed the event, heard about it, or inferred it. Found grammatically in languages like Quechua, Bulgarian, and Turkish.</p></div>
          <div class="src-card"><div class="src-name">Case Alignment</div><p class="src-desc"><strong>Nominative-accusative</strong>: subject of transitive and intransitive verbs share one form (Latin, Russian). <strong>Ergative-absolutive</strong>: subject of intransitive and object of transitive share one form (Basque, Chechen).</p></div>
          <div class="src-card"><div class="src-name">Mutual Intelligibility</div><p class="src-desc">Degree to which speakers of one language can understand speakers of another without prior study. Ranges from 0 (none) to 1 (complete). Values here are from empirical listening tests reported in peer-reviewed linguistics research.</p></div>
        </div>
      </div>
    </div>

  </div><!-- /md-body -->
</div><!-- /menu-drawer -->

<!-- DATA FILES -->
<script src="data/families.js"></script>
<script src="data/languages.js"></script>
<script src="data/intelligibility.js"></script>
<script src="data/countries.js"></script>

<!-- APP -->
<script>
'use strict';

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function getAllLangs(){return typeof LANGUAGE_DATABASE!=='undefined'?Object.values(LANGUAGE_DATABASE):[]}
function getLang(id){return typeof LANGUAGE_DATABASE!=='undefined'?LANGUAGE_DATABASE[id]:null}
function getFamName(id){return(typeof FAMILY_TREE!=='undefined'&&FAMILY_TREE[id])?FAMILY_TREE[id].name:id||'‚Äî'}
function fmtN(n){if(!n)return'0';if(n>=1e9)return(n/1e9).toFixed(1)+'B';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return String(n)}
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

const FHEX={indoEuropean:'#60a5fa',sinoTibetan:'#f87171',nigerCongo:'#34d399',afroasiatic:'#fbbf24',austronesian:'#a78bfa',dravidian:'#fb923c',turkic:'#22d3ee',uralic:'#e879f9',japonic:'#f472b6',koreanic:'#818cf8',taiKadai:'#2dd4bf',austroasiatic:'#a3e635',kartvelian:'#fb7185',mongolic:'#c084fc',semitic:'#fde68a'};
function getFHex(id){return FHEX[id]||'#71717a'}

function endangBadge(s){
  const m={safe:['Safe','badge-safe'],vulnerable:['Vulnerable','badge-vulnerable'],definitely_endangered:['Endangered','badge-endangered'],severely_endangered:['Severely End.','badge-severely'],critically_endangered:['Critical','badge-critical'],extinct:['Extinct','badge-extinct']};
  const[l,c]=m[s]||['‚Äî',''];
  return`<span class="badge ${c}">${l}</span>`;
}

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
(function(){
  const saved=localStorage.getItem('gf-theme')||'dark';
  document.documentElement.setAttribute('data-theme',saved);
  const btn=document.getElementById('themeToggle');
  btn.textContent=saved==='light'?'‚òÄÔ∏è':'üåô';
  btn.addEventListener('click',()=>{
    const cur=document.documentElement.getAttribute('data-theme');
    const nxt=cur==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme',nxt);
    localStorage.setItem('gf-theme',nxt);
    btn.textContent=nxt==='light'?'‚òÄÔ∏è':'üåô';
    updateTiles();
  });
})();

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ
let leafletMap=null,darkTiles,lightTiles;
let mapLayerMode='family';
let mapMarkers=[];

function initMap(){
  if(leafletMap) return;
  leafletMap=L.map('mapContainer',{zoomControl:false,attributionControl:false}).setView([20,10],2);
  L.control.zoom({position:'bottomright'}).addTo(leafletMap);
  L.control.attribution({position:'bottomright',prefix:false}).addTo(leafletMap);
  darkTiles=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ¬© <a href="https://carto.com">CARTO</a>',maxZoom:18});
  lightTiles=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ¬© <a href="https://carto.com">CARTO</a>',maxZoom:18});
  const isDark=document.documentElement.getAttribute('data-theme')!=='light';
  (isDark?darkTiles:lightTiles).addTo(leafletMap);
  populateHeaderFilters();
  renderMarkers();
  renderLegend();
  setupMapEvents();
}

function updateTiles(){
  if(!leafletMap)return;
  if(document.documentElement.getAttribute('data-theme')!=='light'){
    if(leafletMap.hasLayer(lightTiles))leafletMap.removeLayer(lightTiles);
    darkTiles.addTo(leafletMap);
  } else {
    if(leafletMap.hasLayer(darkTiles))leafletMap.removeLayer(darkTiles);
    lightTiles.addTo(leafletMap);
  }
}

function populateHeaderFilters(){
  const langs=getAllLangs();
  const fams=[...new Set(langs.map(l=>l.family))].sort();
  const regs=[...new Set(langs.map(l=>l.macroRegion).filter(Boolean))].sort();
  const hdF=document.getElementById('hdFamily');
  const hdR=document.getElementById('hdRegion');
  const exF=document.getElementById('exFamily');
  const exR=document.getElementById('exRegion');
  fams.forEach(f=>{
    [hdF,exF].forEach(s=>{const o=document.createElement('option');o.value=f;o.textContent=getFamName(f);s.appendChild(o)});
  });
  regs.forEach(r=>{
    [hdR,exR].forEach(s=>{const o=document.createElement('option');o.value=r;o.textContent=r;s.appendChild(o)});
  });
}

function getFiltered(){
  const langs=getAllLangs();
  const search=document.getElementById('mapSearch').value.toLowerCase().trim();
  const fam=document.getElementById('hdFamily').value;
  const reg=document.getElementById('hdRegion').value;
  const status=document.getElementById('hdStatus').value;
  const wordOrder=document.getElementById('fWordOrder').value;
  const morph=document.getElementById('fMorph').value;
  const tone=document.getElementById('fTone').value;
  const showExtinct=document.getElementById('fExtinct').checked;
  return langs.filter(l=>{
    if(!showExtinct&&(l.isExtinct||l.unescoStatus==='extinct'))return false;
    if(search&&!l.name.toLowerCase().includes(search)&&!l.id.toLowerCase().includes(search)&&!(l.nativeName&&l.nativeName.toLowerCase().includes(search))&&!(l.alternateNames&&l.alternateNames.some(a=>a.toLowerCase().includes(search))))return false;
    if(fam&&l.family!==fam)return false;
    if(reg&&l.macroRegion!==reg)return false;
    if(status&&l.unescoStatus!==status)return false;
    if(wordOrder&&l.wordOrder!==wordOrder)return false;
    if(morph&&l.morphType!==morph)return false;
    if(tone&&l.toneSystem!==tone)return false;
    return true;
  });
}

function getMarkerColor(l){
  switch(mapLayerMode){
    case'family':return getFHex(l.family);
    case'endangerment':return({safe:'#34d399',vulnerable:'#fbbf24',definitely_endangered:'#fb923c',severely_endangered:'#f87171',critically_endangered:'#ef4444',extinct:'#52525b'})[l.unescoStatus]||'#71717a';
    case'wordorder':return({SOV:'#60a5fa',SVO:'#34d399',VSO:'#fbbf24',VOS:'#f87171',OVS:'#a78bfa',OSV:'#fb923c'})[l.wordOrder]||'#71717a';
    case'morphology':return({isolating:'#60a5fa',agglutinative:'#34d399',fusional:'#fbbf24',polysynthetic:'#f87171',introflexive:'#a78bfa'})[l.morphType]||'#71717a';
    case'tone':return({none:'#71717a',simple:'#fbbf24',complex:'#f87171'})[l.toneSystem]||'#71717a';
    default:return'#71717a';
  }
}

function renderMarkers(){
  if(!leafletMap)return;
  mapMarkers.forEach(m=>leafletMap.removeLayer(m));
  mapMarkers=[];
  const langs=getFiltered();
  document.getElementById('hdrCount').textContent=langs.length+' lang'+(langs.length!==1?'s':'');
  // Update reset button visibility
  const hasFilter=document.getElementById('mapSearch').value||document.getElementById('hdFamily').value||document.getElementById('hdRegion').value||document.getElementById('hdStatus').value||document.getElementById('fWordOrder').value||document.getElementById('fMorph').value||document.getElementById('fTone').value||document.getElementById('fExtinct').checked;
  document.getElementById('resetBtn').style.display=hasFilter?'block':'none';
  langs.forEach(lang=>{
    if(!lang.lat||!lang.lon)return;
    const r=Math.max(4,Math.min(13,Math.log10(lang.totalSpeakers||lang.l1Speakers||1000)*2));
    const col=getMarkerColor(lang);
    const m=L.circleMarker([lang.lat,lang.lon],{radius:r,fillColor:col,color:col,weight:1,opacity:.8,fillOpacity:.45,bubblingMouseEvents:false});
    m.on('click',()=>openDetail(lang.id));
    m.bindTooltip(`<strong>${lang.name}</strong><br><span style="font-size:10px;color:#aaa">${getFamName(lang.family)}</span>`,{sticky:true,className:'',offset:[0,-4]});
    m.addTo(leafletMap);
    mapMarkers.push(m);
  });
}

function renderLegend(){
  const lg=document.getElementById('mapLegend');
  let rows=[];
  if(mapLayerMode==='family'){
    const shown=(typeof FAMILY_TREE!=='undefined'?Object.values(FAMILY_TREE):[]).slice(0,14);
    shown.forEach(f=>rows.push(`<div class="leg-row"><div class="leg-dot" style="background:${f.color}"></div>${f.name}</div>`));
    rows.push(`<div class="leg-row"><div class="leg-dot" style="background:#71717a"></div>Other</div>`);
  } else if(mapLayerMode==='endangerment'){
    [['#34d399','Safe'],['#fbbf24','Vulnerable'],['#fb923c','Endangered'],['#f87171','Severely End.'],['#ef4444','Critical'],['#52525b','Extinct']].forEach(([c,l])=>rows.push(`<div class="leg-row"><div class="leg-dot" style="background:${c}"></div>${l}</div>`));
  } else if(mapLayerMode==='wordorder'){
    [['#60a5fa','SOV'],['#34d399','SVO'],['#fbbf24','VSO'],['#f87171','VOS'],['#a78bfa','OVS'],['#fb923c','OSV'],['#71717a','Other']].forEach(([c,l])=>rows.push(`<div class="leg-row"><div class="leg-dot" style="background:${c}"></div>${l}</div>`));
  } else if(mapLayerMode==='morphology'){
    [['#60a5fa','Isolating'],['#34d399','Agglutinative'],['#fbbf24','Fusional'],['#f87171','Polysynthetic'],['#71717a','Other']].forEach(([c,l])=>rows.push(`<div class="leg-row"><div class="leg-dot" style="background:${c}"></div>${l}</div>`));
  } else if(mapLayerMode==='tone'){
    [['#71717a','No tone'],['#fbbf24','Simple tone'],['#f87171','Complex tone']].forEach(([c,l])=>rows.push(`<div class="leg-row"><div class="leg-dot" style="background:${c}"></div>${l}</div>`));
  }
  const title=mapLayerMode==='wordorder'?'Word Order':mapLayerMode==='morphology'?'Morphology':mapLayerMode.charAt(0).toUpperCase()+mapLayerMode.slice(1);
  lg.innerHTML=`<div class="leg-title">${title}</div>${rows.join('')}`;
}

function setupMapEvents(){
  ['mapSearch','hdFamily','hdRegion','hdStatus','fWordOrder','fMorph','fTone'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener(id==='mapSearch'?'input':'change',renderMarkers);
  });
  document.getElementById('fExtinct').addEventListener('change',renderMarkers);
  document.querySelectorAll('.ml-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.ml-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      mapLayerMode=btn.dataset.layer;
      renderMarkers();
      renderLegend();
    });
  });
}

function resetFilters(){
  ['mapSearch','hdFamily','hdRegion','hdStatus','fWordOrder','fMorph','fTone'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fExtinct').checked=false;
  renderMarkers();
}

// ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ
function openDetail(langId){
  const lang=getLang(langId);
  if(!lang)return;
  const col=getFHex(lang.family);
  const countries=(lang.countries||[]).map(c=>(typeof COUNTRY_DATA!=='undefined'&&COUNTRY_DATA[c])?COUNTRY_DATA[c].name:c).join(', ');
  const officialIn=(lang.officialIn||[]).map(c=>(typeof COUNTRY_DATA!=='undefined'&&COUNTRY_DATA[c])?COUNTRY_DATA[c].name:c).join(', ');
  document.getElementById('dpTitle').textContent=lang.name;
  document.getElementById('dpBody').innerHTML=`
    <div class="dp-name">${esc(lang.name)}</div>
    ${lang.nativeName&&lang.nativeName!==lang.name?`<div class="dp-native">${esc(lang.nativeName)}</div>`:''}
    ${lang.alternateNames&&lang.alternateNames.length?`<div class="dp-alts">Also known as: ${lang.alternateNames.map(esc).join(', ')}</div>`:''}
    <div class="dp-tags">
      <span class="fam-tag" style="background:${col}18;color:${col}">${esc(getFamName(lang.family))}</span>
      ${endangBadge(lang.unescoStatus)}
      ${lang.isUNLanguage?'<span class="badge" style="background:rgba(0,212,255,.1);color:var(--cyan)">UN</span>':''}
      ${lang.isEULanguage?'<span class="badge" style="background:rgba(0,212,255,.1);color:var(--cyan)">EU</span>':''}
      ${lang.isExtinct?'<span class="badge badge-extinct">Extinct</span>':''}
    </div>
    <div class="dp-sec">
      <div class="dp-sec-title">Classification <span style="font-size:9px;font-weight:400;opacity:.6">‚Äî Glottolog / ISO 639-3</span></div>
      <div class="dp-grid">
        <div class="dp-field"><div class="dp-lbl">ISO 639-3</div><div class="dp-val" style="font-family:var(--font-m)">${esc(lang.id)}</div></div>
        ${lang.iso639_1?`<div class="dp-field"><div class="dp-lbl">ISO 639-1</div><div class="dp-val" style="font-family:var(--font-m)">${esc(lang.iso639_1)}</div></div>`:''}
        <div class="dp-field"><div class="dp-lbl">Family</div><div class="dp-val">${esc(getFamName(lang.family))}</div></div>
        <div class="dp-field"><div class="dp-lbl">Branch</div><div class="dp-val">${esc(lang.branch||'‚Äî')}</div></div>
        ${lang.subbranch?`<div class="dp-field"><div class="dp-lbl">Sub-branch</div><div class="dp-val">${esc(lang.subbranch)}</div></div>`:''}
      </div>
    </div>
    <div class="dp-sec">
      <div class="dp-sec-title">Demographics <span style="font-size:9px;font-weight:400;opacity:.6">‚Äî Ethnologue 27th ed. / Glottolog</span></div>
      <div class="dp-grid">
        <div class="dp-field"><div class="dp-lbl">L1 Speakers</div><div class="dp-val">${(lang.l1Speakers||0).toLocaleString()}</div></div>
        <div class="dp-field"><div class="dp-lbl">L2 Speakers</div><div class="dp-val">${(lang.l2Speakers||0).toLocaleString()}</div></div>
        <div class="dp-field dp-field-wide"><div class="dp-lbl">Total Speakers</div><div class="dp-val">${((lang.totalSpeakers||lang.l1Speakers||0)).toLocaleString()}</div></div>
        <div class="dp-field"><div class="dp-lbl">Region</div><div class="dp-val">${esc(lang.region||lang.macroRegion||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Primary Country</div><div class="dp-val">${esc(lang.primaryCountry||'‚Äî')}</div></div>
      </div>
      ${countries?`<div style="margin-top:6px;font-size:11px;color:var(--ink-low)"><span style="font-weight:600;text-transform:uppercase;letter-spacing:.05em;font-size:9px">Spoken in: </span>${esc(countries)}</div>`:''}
      ${officialIn?`<div style="margin-top:4px;font-size:11px;color:var(--ink-low)"><span style="font-weight:600;text-transform:uppercase;letter-spacing:.05em;font-size:9px">Official in: </span>${esc(officialIn)}</div>`:''}
    </div>
    <div class="dp-sec">
      <div class="dp-sec-title">Endangerment <span style="font-size:9px;font-weight:400;opacity:.6">‚Äî UNESCO Atlas 3rd ed.</span></div>
      <div class="dp-grid">
        <div class="dp-field dp-field-wide"><div class="dp-lbl">UNESCO Status</div><div class="dp-val">${(lang.unescoStatus||'safe').replace(/_/g,' ')}</div></div>
        ${lang.extinctionDate?`<div class="dp-field"><div class="dp-lbl">Last Attested</div><div class="dp-val">${lang.extinctionDate}</div></div>`:''}
      </div>
    </div>
    <div class="dp-sec">
      <div class="dp-sec-title">Typological Features <span style="font-size:9px;font-weight:400;opacity:.6">‚Äî WALS / PHOIBLE</span></div>
      <div class="dp-grid">
        <div class="dp-field"><div class="dp-lbl">Word Order</div><div class="dp-val">${esc(lang.wordOrder||'‚Äî')}</div><div class="dp-cite">WALS 81A</div></div>
        <div class="dp-field"><div class="dp-lbl">Morphology</div><div class="dp-val">${esc(lang.morphType||'‚Äî')}</div><div class="dp-cite">WALS 26A</div></div>
        <div class="dp-field"><div class="dp-lbl">Case Alignment</div><div class="dp-val">${(lang.caseAlignment||'‚Äî').replace(/_/g,'-')}</div><div class="dp-cite">WALS 98A</div></div>
        <div class="dp-field"><div class="dp-lbl">Case Count</div><div class="dp-val">${lang.caseCount!=null?lang.caseCount:'‚Äî'}</div><div class="dp-cite">WALS 49A</div></div>
        <div class="dp-field"><div class="dp-lbl">Tone System</div><div class="dp-val">${esc(lang.toneSystem||'‚Äî')}</div><div class="dp-cite">PHOIBLE</div></div>
        <div class="dp-field"><div class="dp-lbl">Gender System</div><div class="dp-val">${(lang.genderSystem||'‚Äî').replace(/_/g,' ')}</div><div class="dp-cite">WALS 30A</div></div>
        <div class="dp-field"><div class="dp-lbl">Evidentiality</div><div class="dp-val">${esc(lang.evidentiality||'‚Äî')}</div><div class="dp-cite">WALS 77A</div></div>
        <div class="dp-field"><div class="dp-lbl">Vowel Harmony</div><div class="dp-val">${lang.hasVowelHarmony?'Yes':'No'}</div><div class="dp-cite">WALS 116A</div></div>
        <div class="dp-field"><div class="dp-lbl">Clicks</div><div class="dp-val">${lang.hasClicks?'Yes':'No'}</div><div class="dp-cite">PHOIBLE</div></div>
        <div class="dp-field"><div class="dp-lbl">Ejectives</div><div class="dp-val">${lang.hasEjectives?'Yes':'No'}</div><div class="dp-cite">PHOIBLE</div></div>
        <div class="dp-field"><div class="dp-lbl">Nasal Vowels</div><div class="dp-val">${lang.hasNasalVowels?'Yes':'No'}</div><div class="dp-cite">PHOIBLE</div></div>
        <div class="dp-field"><div class="dp-lbl">Consonants</div><div class="dp-val">${esc(lang.consonantInventory||'‚Äî')}</div><div class="dp-cite">PHOIBLE 1A</div></div>
        <div class="dp-field"><div class="dp-lbl">Vowels</div><div class="dp-val">${esc(lang.vowelInventory||'‚Äî')}</div><div class="dp-cite">PHOIBLE 2A</div></div>
        <div class="dp-field"><div class="dp-lbl">Definiteness</div><div class="dp-val">${(lang.definiteness||'‚Äî').replace(/_/g,' ')}</div><div class="dp-cite">WALS 37A</div></div>
        <div class="dp-field"><div class="dp-lbl">Negation</div><div class="dp-val">${(lang.negationType||'‚Äî').replace(/_/g,' ')}</div><div class="dp-cite">WALS 143A</div></div>
      </div>
    </div>
    ${lang.scripts&&lang.scripts.length?`
    <div class="dp-sec">
      <div class="dp-sec-title">Writing Systems</div>
      <div class="dp-grid">
        ${lang.scripts.map(s=>`<div class="dp-field"><div class="dp-lbl">${esc(s.name)}${s.isPrimary?' (primary)':''}</div><div class="dp-val">${esc(s.type)} ¬∑ ${esc(s.direction.toUpperCase())}</div></div>`).join('')}
      </div>
    </div>`:''}
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
      <button class="btn btn-ghost btn-sm" onclick="closeDetail();openMenu('explorer');showExplDetail('${esc(lang.id)}')">Full Explorer Profile ‚Üí</button>
    </div>
  `;
  document.getElementById('detailPanel').classList.add('open');
}

function closeDetail(){
  document.getElementById('detailPanel').classList.remove('open');
}

// ‚îÄ‚îÄ MENU DRAWER ‚îÄ‚îÄ
let drawerLoaded={};
function openMenu(tab){
  closeDetail();
  document.getElementById('menuDrawer').classList.add('open');
  switchDrawerTab(tab||'explorer');
  if(!drawerLoaded.explorer){drawerLoaded.explorer=true;initExplorer();}
}
function closeMenu(){
  document.getElementById('menuDrawer').classList.remove('open');
}
function closeAll(){
  closeDetail();
  closeMenu();
}

function switchDrawerTab(tab){
  document.querySelectorAll('.md-tab').forEach(t=>{
    t.classList.toggle('active',t.dataset.drawer===tab);
  });
  document.querySelectorAll('.md-view').forEach(v=>{
    v.style.display=v.id==='drawer-'+tab?'block':'none';
  });
  if(tab==='families'&&!drawerLoaded.families){drawerLoaded.families=true;initFamilyTree();}
  if(tab==='tools'&&!drawerLoaded.tools){drawerLoaded.tools=true;initTools();}
  if(tab==='sources'&&!drawerLoaded.sources){drawerLoaded.sources=true;}
}

document.querySelectorAll('.md-tab').forEach(tab=>{
  tab.addEventListener('click',()=>switchDrawerTab(tab.dataset.drawer));
});
document.getElementById('menuBtn').addEventListener('click',()=>openMenu());

// ‚îÄ‚îÄ EXPLORER ‚îÄ‚îÄ
let exActiveChips=[];
function initExplorer(){
  ['exSearch','exFamily','exRegion','exStatus'].forEach(id=>{
    document.getElementById(id).addEventListener(id==='exSearch'?'input':'change',renderExplorer);
  });
  renderExplorer();
}

function getExFiltered(){
  const langs=getAllLangs();
  const search=document.getElementById('exSearch').value.toLowerCase().trim();
  const fam=document.getElementById('exFamily').value;
  const reg=document.getElementById('exRegion').value;
  const status=document.getElementById('exStatus').value;
  return langs.filter(l=>{
    if(search&&!l.name.toLowerCase().includes(search)&&!l.id.toLowerCase().includes(search)&&!(l.nativeName&&l.nativeName.toLowerCase().includes(search))&&!(l.alternateNames&&l.alternateNames.some(a=>a.toLowerCase().includes(search))))return false;
    if(fam&&l.family!==fam)return false;
    if(reg&&l.macroRegion!==reg)return false;
    if(status&&l.unescoStatus!==status)return false;
    return true;
  });
}

function renderExplorer(){
  // Check if explorer detail is showing
  const detDiv=document.getElementById('exDetail');
  if(detDiv&&detDiv.style.display==='block')return;
  const langs=getExFiltered();
  document.getElementById('exCount').textContent=langs.length+' language'+(langs.length!==1?'s':'')+' found';
  const toShow=langs.slice(0,60);
  document.getElementById('exResults').innerHTML=toShow.map(l=>`
    <div class="lang-card" onclick="showExplDetail('${esc(l.id)}')" tabindex="0" role="button" aria-label="${esc(l.name)}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:3px">
        <div><div class="lc-name">${esc(l.name)}</div>${l.nativeName&&l.nativeName!==l.name?`<div class="lc-native">${esc(l.nativeName)}</div>`:''}</div>
        <span class="lc-iso">${esc(l.id)}</span>
      </div>
      <div class="lc-badges">
        <span class="fam-tag" style="background:${getFHex(l.family)}18;color:${getFHex(l.family)}">${esc(getFamName(l.family))}</span>
        ${endangBadge(l.unescoStatus)}
      </div>
      <div class="lc-foot">
        <span>${fmtN(l.totalSpeakers||l.l1Speakers||0)} speakers</span>
        <span>${esc(l.wordOrder||'‚Äî')} ¬∑ ${esc(l.morphType||'‚Äî')}</span>
      </div>
    </div>
  `).join('')+(langs.length>60?`<div style="text-align:center;padding:18px;color:var(--ink-low);font-size:12px;grid-column:1/-1">Showing 60 of ${langs.length} ‚Äî refine search to see more</div>`:'');
  // Ensure detail div exists
  if(!document.getElementById('exDetail')){
    const d=document.createElement('div');d.id='exDetail';d.style.display='none';
    document.getElementById('exResults').after(d);
  }
}

function showExplDetail(langId){
  const lang=getLang(langId);
  if(!lang)return;
  // Hide grid, show detail
  document.getElementById('exResults').style.display='none';
  document.getElementById('exCount').style.display='none';
  const topEl=document.querySelector('.expl-top');
  if(topEl)topEl.style.display='none';
  let d=document.getElementById('exDetail');
  if(!d){d=document.createElement('div');d.id='exDetail';document.getElementById('exResults').after(d);}
  d.style.display='block';
  const col=getFHex(lang.family);
  const countries=(lang.countries||[]).map(c=>(typeof COUNTRY_DATA!=='undefined'&&COUNTRY_DATA[c])?COUNTRY_DATA[c].name:c).join(', ');
  const officialIn=(lang.officialIn||[]).map(c=>(typeof COUNTRY_DATA!=='undefined'&&COUNTRY_DATA[c])?COUNTRY_DATA[c].name:c).join(', ');
  d.innerHTML=`
    <button onclick="closeExplDetail()" style="display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:500;color:var(--ink-mid);cursor:pointer;margin-bottom:18px;background:var(--raised);border:1px solid var(--border);border-radius:var(--r);padding:6px 12px">‚Üê Back to results</button>
    <div style="max-width:860px">
      <div style="font-family:var(--font-h);font-size:1.7rem;font-weight:700;letter-spacing:-.03em;color:var(--ink);margin-bottom:3px">${esc(lang.name)}</div>
      ${lang.nativeName&&lang.nativeName!==lang.name?`<div style="font-size:14px;color:var(--ink-low);margin-bottom:3px">${esc(lang.nativeName)}</div>`:''}
      ${lang.alternateNames&&lang.alternateNames.length?`<div style="font-size:11px;color:var(--ink-dim);margin-bottom:12px">Also: ${lang.alternateNames.map(esc).join(', ')}</div>`:''}
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:24px">
        <span class="fam-tag" style="background:${col}18;color:${col};padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600">${esc(getFamName(lang.family))}</span>
        ${endangBadge(lang.unescoStatus)}
        ${lang.isUNLanguage?'<span class="badge" style="background:rgba(0,212,255,.1);color:var(--cyan)">UN Language</span>':''}
        ${lang.isEULanguage?'<span class="badge" style="background:rgba(0,212,255,.1);color:var(--cyan)">EU Language</span>':''}
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-bottom:20px">
        <div class="dp-field"><div class="dp-lbl">ISO 639-3</div><div class="dp-val" style="font-family:var(--font-m)">${esc(lang.id)}</div></div>
        ${lang.iso639_1?`<div class="dp-field"><div class="dp-lbl">ISO 639-1</div><div class="dp-val" style="font-family:var(--font-m)">${esc(lang.iso639_1)}</div></div>`:''}
        <div class="dp-field"><div class="dp-lbl">Branch</div><div class="dp-val">${esc(lang.branch||'‚Äî')}</div></div>
        ${lang.subbranch?`<div class="dp-field"><div class="dp-lbl">Sub-branch</div><div class="dp-val">${esc(lang.subbranch)}</div></div>`:''}
        <div class="dp-field"><div class="dp-lbl">L1 Speakers</div><div class="dp-val">${(lang.l1Speakers||0).toLocaleString()}</div></div>
        <div class="dp-field"><div class="dp-lbl">L2 Speakers</div><div class="dp-val">${(lang.l2Speakers||0).toLocaleString()}</div></div>
        <div class="dp-field"><div class="dp-lbl">Total Speakers</div><div class="dp-val">${(lang.totalSpeakers||lang.l1Speakers||0).toLocaleString()}</div></div>
        <div class="dp-field"><div class="dp-lbl">UNESCO Status</div><div class="dp-val">${(lang.unescoStatus||'safe').replace(/_/g,' ')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Region</div><div class="dp-val">${esc(lang.macroRegion||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Word Order</div><div class="dp-val">${esc(lang.wordOrder||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Morphology</div><div class="dp-val">${esc(lang.morphType||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Case Alignment</div><div class="dp-val">${(lang.caseAlignment||'‚Äî').replace(/_/g,'-')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Case Count</div><div class="dp-val">${lang.caseCount!=null?lang.caseCount:'‚Äî'}</div></div>
        <div class="dp-field"><div class="dp-lbl">Tone System</div><div class="dp-val">${esc(lang.toneSystem||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Gender System</div><div class="dp-val">${(lang.genderSystem||'‚Äî').replace(/_/g,' ')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Evidentiality</div><div class="dp-val">${esc(lang.evidentiality||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Vowel Harmony</div><div class="dp-val">${lang.hasVowelHarmony?'Yes':'No'}</div></div>
        <div class="dp-field"><div class="dp-lbl">Clicks</div><div class="dp-val">${lang.hasClicks?'Yes':'No'}</div></div>
        <div class="dp-field"><div class="dp-lbl">Ejectives</div><div class="dp-val">${lang.hasEjectives?'Yes':'No'}</div></div>
        <div class="dp-field"><div class="dp-lbl">Nasal Vowels</div><div class="dp-val">${lang.hasNasalVowels?'Yes':'No'}</div></div>
        <div class="dp-field"><div class="dp-lbl">Consonants</div><div class="dp-val">${esc(lang.consonantInventory||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Vowels</div><div class="dp-val">${esc(lang.vowelInventory||'‚Äî')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Definiteness</div><div class="dp-val">${(lang.definiteness||'‚Äî').replace(/_/g,' ')}</div></div>
        <div class="dp-field"><div class="dp-lbl">Negation</div><div class="dp-val">${(lang.negationType||'‚Äî').replace(/_/g,' ')}</div></div>
      </div>
      ${countries?`<div style="font-size:12px;color:var(--ink-low);margin-bottom:6px"><strong style="text-transform:uppercase;font-size:9px;letter-spacing:.06em">Spoken in: </strong>${esc(countries)}</div>`:''}
      ${officialIn?`<div style="font-size:12px;color:var(--ink-low);margin-bottom:16px"><strong style="text-transform:uppercase;font-size:9px;letter-spacing:.06em">Official in: </strong>${esc(officialIn)}</div>`:''}
      ${lang.scripts&&lang.scripts.length?`<div style="margin-top:6px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink-low);margin-bottom:8px">Writing Systems</div><div style="display:flex;gap:8px;flex-wrap:wrap">${lang.scripts.map(s=>`<div class="dp-field"><div class="dp-lbl">${esc(s.name)}</div><div class="dp-val">${esc(s.type)} ¬∑ ${esc(s.direction.toUpperCase())}</div></div>`).join('')}</div></div>`:''}
      <div style="margin-top:18px;padding-top:14px;border-top:1px solid var(--border);font-size:11px;color:var(--ink-dim)">
        Classification: Glottolog 5.0 ¬∑ Demographics: Ethnologue 27th ed. ¬∑ Typology: WALS, PHOIBLE 2.0 ¬∑ Endangerment: UNESCO Atlas 3rd ed.
      </div>
    </div>
  `;
}

function closeExplDetail(){
  const d=document.getElementById('exDetail');
  if(d)d.style.display='none';
  document.getElementById('exResults').style.display='';
  document.getElementById('exCount').style.display='';
  const topEl=document.querySelector('.expl-top');
  if(topEl)topEl.style.display='';
}

// ‚îÄ‚îÄ FAMILIES ‚îÄ‚îÄ
function initFamilyTree(){
  if(typeof FAMILY_TREE==='undefined')return;
  renderFamTree();
  document.getElementById('famSearch').addEventListener('input',renderFamTree);
}

function countBL(branches){
  let n=0;if(!branches)return 0;
  Object.values(branches).forEach(b=>{if(b.languages)n+=b.languages.length;if(b.branches)n+=countBL(b.branches)});
  return n;
}

function renderFamTree(){
  const search=document.getElementById('famSearch').value.toLowerCase().trim();
  if(typeof FAMILY_TREE==='undefined')return;
  document.getElementById('famTree').innerHTML=Object.values(FAMILY_TREE).map(fam=>{
    const lc=countBL(fam.branches);
    if(search&&!fam.name.toLowerCase().includes(search)&&!famBMatch(fam.branches,search))return'';
    return`<div class="tree-fam">
      <div class="tree-fam-hd" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.tree-chev').classList.toggle('open')">
        <div class="tree-fam-left"><div class="tree-dot" style="background:${fam.color}"></div>${esc(fam.name)}<span class="tree-chev">‚ñ∂</span></div>
        <div class="tree-stats"><span>${lc} langs</span><span>${fmtN(fam.speakers||0)} speakers</span></div>
      </div>
      <div class="tree-body">${fam.branches?renderBranches(fam.branches,search):''}</div>
    </div>`;
  }).join('');
}

function renderBranches(branches,search){
  return Object.values(branches).map(b=>{
    const langs=b.languages||[];
    if(search&&!b.name.toLowerCase().includes(search)&&!famBMatch(b.branches,search)&&!langs.some(id=>{const l=getLang(id);return l&&l.name.toLowerCase().includes(search)}))return'';
    return`<div class="tree-branch">
      <div class="tree-br-hd" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.tree-chev').classList.toggle('open')">
        <span class="tree-chev" style="font-size:9px">‚ñ∂</span>${esc(b.name)}
        <span style="font-size:10px;color:var(--ink-dim);margin-left:auto">${b.branches?countBL(b.branches)+langs.length:langs.length}</span>
      </div>
      <div class="tree-sub">
        ${b.branches?renderBranches(b.branches,search):''}
        ${langs.map(id=>{
          const l=getLang(id);
          if(search&&l&&!l.name.toLowerCase().includes(search))return'';
          return`<div class="tree-lang" onclick="switchDrawerTab('explorer');showExplDetail('${esc(id)}')"><span>${l?esc(l.name):esc(id)}</span><span class="tree-lang-iso">${esc(id)}</span></div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

function famBMatch(branches,search){
  if(!branches)return false;
  return Object.values(branches).some(b=>b.name.toLowerCase().includes(search)||(b.languages||[]).some(id=>{const l=getLang(id);return l&&l.name.toLowerCase().includes(search)})||famBMatch(b.branches,search));
}

// ‚îÄ‚îÄ TOOLS ‚îÄ‚îÄ
let compSlots=[];
function initTools(){
  document.querySelectorAll('.tool-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.tool-tab').forEach(t=>{t.classList.remove('active');t.setAttribute('aria-selected','false')});
      document.querySelectorAll('.tool-panel').forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');tab.setAttribute('aria-selected','true');
      document.getElementById('tool-'+tab.dataset.tool).classList.add('active');
    });
  });
  const langs=getAllLangs().filter(l=>!l.isExtinct).sort((a,b)=>a.name.localeCompare(b.name));
  ['intLang','simLang'].forEach(id=>{
    const s=document.getElementById(id);
    langs.forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=`${l.name} [${l.id}]`;s.appendChild(o)});
  });
  if(typeof FAMILY_TREE!=='undefined'){
    const s=document.getElementById('tlFamily');
    Object.values(FAMILY_TREE).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent=f.name;s.appendChild(o)});
  }
  document.getElementById('intLang').addEventListener('change',runIntelligibility);
  document.getElementById('simLang').addEventListener('change',runSimilarity);
  document.getElementById('tlFamily').addEventListener('change',runTimeline);
  compSlots=[];addCompSlot();addCompSlot();
  runTimeline();runWorldStats();
}

function runIntelligibility(){
  const id=document.getElementById('intLang').value;
  const c=document.getElementById('intResults');
  if(!id){c.innerHTML='';return}
  if(typeof INTELLIGIBILITY_EDGES==='undefined'){c.innerHTML='<p style="color:var(--ink-low)">Data not loaded.</p>';return}
  const edges=INTELLIGIBILITY_EDGES.filter(e=>e.source===id||e.target===id);
  if(!edges.length){c.innerHTML='<p style="color:var(--ink-low)">No intelligibility data for this language.</p>';return}
  const lang=getLang(id);
  c.innerHTML=edges.map(e=>{
    const othId=e.source===id?e.target:e.source;
    const oth=getLang(othId);if(!oth)return'';
    const fwd=e.source===id?e.score:e.reverse;
    const rev=e.source===id?e.reverse:e.score;
    const col=fwd>=.8?'var(--safe)':fwd>=.6?'var(--vuln)':fwd>=.4?'var(--endanger)':'var(--severe)';
    return`<div class="res-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:9px">
        <div><span style="font-weight:600;font-size:13px">${esc(oth.name)}</span><span style="font-family:var(--font-m);font-size:10px;color:var(--ink-low);margin-left:7px">${esc(othId)}</span></div>
        <span class="badge" style="background:${col}18;color:${col}">${e.category.replace(/_/g,' ')}</span>
      </div>
      <div style="margin-bottom:7px">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--ink-low);margin-bottom:3px"><span>${esc(lang.name)} ‚Üí ${esc(oth.name)}</span><span style="color:var(--ink)">${Math.round(fwd*100)}%</span></div>
        <div class="bar-wrap"><div class="bar-fill" style="width:${fwd*100}%;background:${col}"></div></div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--ink-low);margin-bottom:3px"><span>${esc(oth.name)} ‚Üí ${esc(lang.name)}</span><span style="color:var(--ink)">${Math.round(rev*100)}%</span></div>
        <div class="bar-wrap"><div class="bar-fill" style="width:${rev*100}%;background:${col}"></div></div>
      </div>
      <div style="font-size:10px;color:var(--ink-low);margin-top:7px">Modality: ${esc(e.modality||'spoken')}</div>
    </div>`;
  }).join('');
}

function runSimilarity(){
  const id=document.getElementById('simLang').value;
  const c=document.getElementById('simResults');
  if(!id){c.innerHTML='';return}
  const lang=getLang(id);
  const features=[{key:'wordOrder',w:15},{key:'morphType',w:15},{key:'caseAlignment',w:12},{key:'toneSystem',w:10},{key:'genderSystem',w:8},{key:'evidentiality',w:7},{key:'consonantInventory',w:5},{key:'vowelInventory',w:5},{key:'definiteness',w:5},{key:'negationType',w:5}];
  const bools=[{key:'hasVowelHarmony',w:5},{key:'hasClicks',w:3},{key:'hasEjectives',w:3},{key:'hasNasalVowels',w:2}];
  const scores=getAllLangs().filter(l=>l.id!==id&&!l.isExtinct).map(oth=>{
    let sc=0,tot=0;
    features.forEach(f=>{if(lang[f.key]&&oth[f.key]){tot+=f.w;if(lang[f.key]===oth[f.key])sc+=f.w}});
    bools.forEach(f=>{tot+=f.w;if(lang[f.key]===oth[f.key])sc+=f.w});
    if(lang.caseCount!=null&&oth.caseCount!=null){tot+=8;const d=Math.abs(lang.caseCount-oth.caseCount);if(d===0)sc+=8;else if(d<=2)sc+=5;else if(d<=5)sc+=2}
    return{lang:oth,score:tot>0?sc/tot:0};
  }).sort((a,b)=>b.score-a.score).slice(0,20);
  c.innerHTML=`<div style="margin-bottom:12px;font-size:13px;color:var(--ink-mid)">Most grammatically similar to <strong style="color:var(--ink)">${esc(lang.name)}</strong></div>`+
  scores.map((item,i)=>{
    const col=item.score>=.8?'var(--safe)':item.score>=.6?'var(--cyan)':item.score>=.4?'var(--vuln)':'var(--ink-low)';
    return`<div class="res-card" style="display:flex;align-items:center;gap:10px">
      <div style="font-family:var(--font-m);font-size:11px;color:var(--ink-dim);width:20px;text-align:right">${i+1}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-weight:600;font-size:13px">${esc(item.lang.name)}</span>
          <span class="fam-tag" style="background:${getFHex(item.lang.family)}18;color:${getFHex(item.lang.family)};padding:2px 7px;border-radius:999px;font-size:10px;font-weight:600">${esc(getFamName(item.lang.family))}</span>
        </div>
        <div style="display:flex;align-items:center;gap:7px">
          <div class="bar-wrap"><div class="bar-fill" style="width:${item.score*100}%;background:${col}"></div></div>
          <span style="font-size:11px;color:${col};white-space:nowrap">${Math.round(item.score*100)}%</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function addCompSlot(){
  if(compSlots.length>=5)return;
  const idx=compSlots.length;compSlots.push('');
  const div=document.createElement('div');div.style.minWidth='160px';
  div.innerHTML=`<div class="fl-lbl">Language ${idx+1}</div><select class="sel" id="comp-${idx}" onchange="compSlots[${idx}]=this.value;renderComp()"><option value="">Select‚Ä¶</option></select>`;
  document.getElementById('compSelectors').appendChild(div);
  const s=div.querySelector('select');
  getAllLangs().filter(l=>!l.isExtinct).sort((a,b)=>a.name.localeCompare(b.name)).forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=l.name;s.appendChild(o)});
  if(compSlots.length>=5)document.getElementById('addCompBtn').style.display='none';
}

function renderComp(){
  const sel=compSlots.filter(s=>s).map(id=>getLang(id)).filter(Boolean);
  const c=document.getElementById('compResults');
  if(sel.length<2){c.innerHTML='<p style="color:var(--ink-low);font-size:13px">Select at least 2 languages to compare.</p>';return}
  const features=[
    {key:'family',lbl:'Family',fmt:v=>getFamName(v)},
    {key:'wordOrder',lbl:'Word Order'},{key:'morphType',lbl:'Morphological Type'},
    {key:'caseAlignment',lbl:'Case Alignment',fmt:v=>(v||'‚Äî').replace(/_/g,'-')},
    {key:'caseCount',lbl:'Case Count'},{key:'toneSystem',lbl:'Tone System'},
    {key:'genderSystem',lbl:'Gender System',fmt:v=>(v||'‚Äî').replace(/_/g,' ')},
    {key:'evidentiality',lbl:'Evidentiality'},
    {key:'hasVowelHarmony',lbl:'Vowel Harmony',fmt:v=>v?'Yes':'No'},
    {key:'hasClicks',lbl:'Clicks',fmt:v=>v?'Yes':'No'},{key:'hasEjectives',lbl:'Ejectives',fmt:v=>v?'Yes':'No'},
    {key:'consonantInventory',lbl:'Consonant Inventory'},{key:'vowelInventory',lbl:'Vowel Inventory'},
    {key:'definiteness',lbl:'Definiteness',fmt:v=>(v||'‚Äî').replace(/_/g,' ')},
    {key:'negationType',lbl:'Negation',fmt:v=>(v||'‚Äî').replace(/_/g,' ')},
    {key:'totalSpeakers',lbl:'Total Speakers',fmt:v=>fmtN(v||0)},
    {key:'unescoStatus',lbl:'Endangerment',fmt:v=>(v||'‚Äî').replace(/_/g,' ')}
  ];
  c.innerHTML=`<div class="tbl-wrap"><table class="comp-table"><thead><tr><th>Feature</th>${sel.map(l=>`<th>${esc(l.name)}</th>`).join('')}</tr></thead><tbody>
    ${features.map(f=>{const vals=sel.map(l=>f.fmt?f.fmt(l[f.key]):(l[f.key]??'‚Äî'));const same=vals.every(v=>v===vals[0])&&vals[0]!=='‚Äî';return`<tr${same?' class="match"':''}><td>${f.lbl}</td>${vals.map(v=>`<td>${esc(String(v))}</td>`).join('')}</tr>`;}).join('')}
  </tbody></table></div>`;
}

function runTimeline(){
  const fam=document.getElementById('tlFamily').value;
  const c=document.getElementById('tlResults');
  let langs=getAllLangs().filter(l=>l.isExtinct||l.unescoStatus==='extinct');
  if(fam)langs=langs.filter(l=>l.family===fam);
  langs.sort((a,b)=>(b.extinctionDate||0)-(a.extinctionDate||0));
  if(!langs.length){c.innerHTML='<p style="color:var(--ink-low);font-size:13px">No extinct languages for this filter.</p>';return}
  c.innerHTML=`<div style="margin-bottom:12px;font-size:12px;color:var(--ink-low)">${langs.length} extinct / historical language${langs.length!==1?'s':''}</div>
  <div class="tl-wrap">${langs.slice(0,40).map(l=>`
    <div class="tl-item"><div class="tl-dot" style="background:${getFHex(l.family)}"></div>
    <div class="tl-period">${l.extinctionDate?`~${l.extinctionDate}`:'date unknown'}</div>
    <div class="tl-name">${esc(l.name)}</div>
    <div class="tl-meta">${esc(getFamName(l.family))} ¬∑ ${esc(l.region||l.macroRegion||'‚Äî')}</div></div>
  `).join('')}</div>${langs.length>40?`<div style="color:var(--ink-low);font-size:12px;margin-top:10px">Showing 40 of ${langs.length}</div>`:''}`;
}

function runWorldStats(){
  const c=document.getElementById('wstatsResults');
  const langs=getAllLangs();
  if(!langs.length){c.innerHTML='<p style="color:var(--ink-low)">Data not loaded.</p>';return}
  const tally=(arr,key)=>{const o={};arr.forEach(l=>{if(l[key])o[l[key]]=(o[l[key]]||0)+1});return Object.entries(o).sort((a,b)=>b[1]-a[1])};
  const famE=tally(langs,'family');const maxF=famE[0]?famE[0][1]:1;
  const woE=tally(langs,'wordOrder');const maxW=woE[0]?woE[0][1]:1;
  const morphE=tally(langs,'morphType');const maxM=morphE[0]?morphE[0][1]:1;
  const endC={};langs.forEach(l=>{const s=l.unescoStatus||'unknown';endC[s]=(endC[s]||0)+1});
  const endCol={safe:'var(--safe)',vulnerable:'var(--vuln)',definitely_endangered:'var(--endanger)',severely_endangered:'var(--severe)',critically_endangered:'var(--critical)',extinct:'var(--extinct)'};
  const total=langs.length;
  c.innerHTML=`
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:20px">
    <div class="dp-field"><div class="dp-lbl">Total Languages</div><div class="dp-val" style="font-size:1.4rem;color:var(--cyan)">${total}</div></div>
    <div class="dp-field"><div class="dp-lbl">Families</div><div class="dp-val" style="font-size:1.4rem;color:var(--cyan)">${new Set(langs.map(l=>l.family)).size}</div></div>
    <div class="dp-field"><div class="dp-lbl">Endangered (any level)</div><div class="dp-val" style="font-size:1.4rem;color:var(--endanger)">${langs.filter(l=>l.unescoStatus&&l.unescoStatus!=='safe').length}</div></div>
    <div class="dp-field"><div class="dp-lbl">Extinct / No Speakers</div><div class="dp-val" style="font-size:1.4rem;color:var(--extinct)">${langs.filter(l=>l.isExtinct||l.unescoStatus==='extinct').length}</div></div>
  </div>
  <div class="stats-grid">
    <div class="stats-card"><div class="stats-ct">Languages by Family</div>${famE.slice(0,14).map(([f,n])=>`<div class="s-row"><div class="s-bar-top"><span>${esc(getFamName(f))}</span><span>${n}</span></div><div class="bar-wrap"><div class="bar-fill" style="width:${(n/maxF)*100}%;background:${getFHex(f)}"></div></div></div>`).join('')}</div>
    <div class="stats-card"><div class="stats-ct">Word Order Distribution</div>${woE.map(([w,n])=>`<div class="s-row"><div class="s-bar-top"><span>${esc(w)}</span><span>${n}</span></div><div class="bar-wrap"><div class="bar-fill" style="width:${(n/maxW)*100}%;background:var(--cyan)"></div></div></div>`).join('')}</div>
    <div class="stats-card"><div class="stats-ct">Endangerment Status</div>${Object.entries(endC).map(([s,n])=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px"><span style="color:${endCol[s]||'var(--ink-mid)'}">${s.replace(/_/g,' ')}</span><span style="font-weight:600">${n}</span></div>`).join('')}</div>
    <div class="stats-card"><div class="stats-ct">Morphological Type</div>${morphE.map(([m,n])=>`<div class="s-row"><div class="s-bar-top"><span>${esc(m)}</span><span>${n}</span></div><div class="bar-wrap"><div class="bar-fill" style="width:${(n/maxM)*100}%;background:var(--violet)"></div></div></div>`).join('')}</div>
  </div>`;
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  initMap();
  if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
});
</script>
</body>
</html>
